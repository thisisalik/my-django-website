{% extends 'base.html' %}
{% load static %}

{% block content %}

<h2 style="display: flex; align-items: center; gap: 10px;">
  My Profile
  {% if profile.profile_picture %}
    <img src="{{ profile.profile_picture.url }}" alt="Profile Picture"
         id="profilePic"
         style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer;">
    <!-- Modal (hidden by default) -->
    <div id="picModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
      <img id="modalImg" src="{{ profile.profile_picture.url }}" style="max-width: 90%; max-height: 90%; border-radius: 12px;">
    </div>
  {% else %}
    üë§
  {% endif %}
</h2>

<p><strong>Name:</strong> {{ profile.name }}</p>
<p><strong>Age:</strong> {{ profile.age }}</p>
<p><strong>Gender:</strong> {{ profile.gender }}</p>
<p><strong>Preferred Gender:</strong> {{ profile.preferred_gender }}</p>
<p><strong>Preferred Age:</strong> {{ profile.preferred_age_min }} - {{ profile.preferred_age_max }}</p>
<p><strong>City:</strong> {{ profile.location }}</p>

{% if profile.connection_types %}
  <p><strong>Interested in:</strong> {{ profile.get_connection_type_labels|join:', ' }}</p>
{% endif %}

<hr>
<h2>Your Letter üíå</h2>

{% if letters %}
  {% for letter in letters %}
    <div style="border:1px solid #ccc; padding:15px; margin-bottom:20px; border-radius:10px;">

      {% if letter.letter_type == "text" %}
        {% if letter.text_content %}
          <div class="letter-card">
            <div class="letter-body">üìù {{ letter.text_content|linebreaksbr }}</div>
          </div>
        {% else %}
          <div class="letter-card"><em>No text available.</em></div>
        {% endif %}

      {% elif letter.letter_type == "pdf" and letter.pdf %}
        {% with gid="p"|add:letter.id|stringformat:"s" %}
          <link rel="preload" href="{% static 'vendor/pdfjs/pdf.worker.min.js' %}" as="script">
          <style>
            .pdf-card { border:1px solid #ddd;border-radius:12px;padding:12px; }
            .pdf-toolbar { display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-start;margin-bottom:10px; }
            .pdf-btn { border:1px solid #ccc;background:#f6f6f6;padding:6px 10px;border-radius:8px;cursor:pointer;line-height:1;font-size:14px; }
            .pdf-btn:disabled { opacity:.4;cursor:not-allowed; }
            .pdf-badge { font-size:13px;color:#444;min-width:56px;text-align:center; }
            .pdf-canvas-wrap { width:100%;max-height:40vh;overflow:auto;border-radius:8px;background:#fafafa;display:flex;justify-content:center;align-items:flex-start; }
            .pdf-canvas-wrap::-webkit-scrollbar { height:8px;width:8px; }
            .pdf-canvas-wrap::-webkit-scrollbar-thumb { background:#d0d0d0;border-radius:8px; }
            @media (max-width:420px){
              .pdf-card{padding:8px;border-radius:10px}
              .pdf-toolbar{gap:6px;margin-bottom:6px}
              .pdf-btn{padding:5px 8px;border-radius:7px;font-size:13px}
              .pdf-badge{font-size:12px;min-width:48px}
              .pdf-canvas-wrap{max-height:50vh}
            }
          </style>

          <div class="pdf-card"
               id="pdfCard-{{ gid }}"
               data-gid="{{ gid }}"
               data-pdf-url="{{ letter.pdf.url }}">
            <div class="pdf-toolbar">
              <button type="button" class="pdf-btn pdf-prev" data-gid="{{ gid }}">‚óÄ</button>
              <span class="pdf-badge pdf-page-label" data-gid="{{ gid }}">1 / 1</span>
              <button type="button" class="pdf-btn pdf-next" data-gid="{{ gid }}">‚ñ∂</button>

              <span style="width:12px;"></span>

              <button type="button" class="pdf-btn pdf-zoom-out" data-gid="{{ gid }}">‚àí</button>
              <span class="pdf-badge pdf-zoom-label" data-gid="{{ gid }}">100%</span>
              <button type="button" class="pdf-btn pdf-zoom-in" data-gid="{{ gid }}">Ôºã</button>
              <button type="button" class="pdf-btn pdf-fit" data-gid="{{ gid }}">Fit</button>
            </div>
            <div class="pdf-canvas-wrap">
              <canvas id="pdfCanvas-{{ gid }}"></canvas>
            </div>
          </div>
        {% endwith %}

      {% elif letter.letter_type == "image" and letter.images.exists %}
        {% with group_id=forloop.counter images=letter.images.all %}
          <div class="letter-image-group" data-group="{{ group_id }}" style="position: relative; max-width: 400px; margin-top: 10px;">
            {% for image in images %}
              <div class="slide slide-group-{{ group_id }}"
                   id="slide-{{ group_id }}-{{ forloop.counter }}"
                   style="display: {% if forloop.first %}block{% else %}none{% endif %};">
                <img src="{{ image.image.url }}"
                     alt="Letter Image"
                     class="clickable-image"
                     style="width: 100%; border-radius: 8px; max-height: 400px; object-fit: contain; cursor: pointer;">
              </div>
            {% endfor %}
            {% if images|length > 1 %}
              <button class="nav-btn prev-btn" data-group="{{ group_id }}"
                      style="position: absolute; left: 0; top: 45%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px;">&larr;</button>
              <button class="nav-btn next-btn" data-group="{{ group_id }}"
                      style="position: absolute; right: 0; top: 45%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px;">&rarr;</button>
            {% endif %}
          </div>
        {% endwith %}
      {% endif %}

    </div>
  {% endfor %}
{% else %}
  <p>You have no letters uploaded yet.</p>
  <br>
  <a href="{% url 'upload_letter' %}" class="btn btn-primary">‚ûï Upload Letter</a>
{% endif %}

<a href="https://donate.stripe.com/test_aFa00l0IT2tg8z0bw7ao801"
   target="_blank"
   class="btn btn-warning" style="margin-top: 15px;">üíñ Support the Project</a>

<br><br>
<a href="{% url 'edit_profile' %}" class="btn btn-secondary">‚úèÔ∏è Edit Profile</a>

<hr style="margin: 25px 0;">
<div style="background:#f9f9f9; padding:15px; border-radius:10px; font-size:14px;">
  <p>If you run into problems or want to share feedback, reach out:</p>
  <ul style="margin:0; padding-left:18px; line-height:1.6;">
    Email: <a href="turtledatingapp@gmail.com">hello@yourdomain.com</a>
  </ul>
</div>

{% endblock %}

{% block extra_js %}
  {# Serve pdf.js locally so CSP can be strict #}
  <script src="{% static 'vendor/pdfjs/pdf.min.js' %}"></script>
  <script src="{% static 'js/view_profile_pdf.js' %}"></script>
  <script src="{% static 'js/view_profile_slider.js' %}"></script>
  <script src="{% static 'js/view_profile_modal.js' %}"></script>
{% endblock %}
