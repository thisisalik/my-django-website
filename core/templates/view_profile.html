{% extends 'base.html' %}
{% load static %}

{% block content %}

<h2 style="display: flex; align-items: center; gap: 10px;">
  My Profile
  {% if profile.profile_picture %}
  <img src="{{ profile.profile_picture.url }}" alt="Profile Picture"
  id="profilePic" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer;">

<!-- Modal (hidden by default) -->
<div id="picModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
<img id="modalImg" src="{{ profile.profile_picture.url }}" style="max-width: 90%; max-height: 90%; border-radius: 12px;">
</div>

  {% else %}
    üë§
  {% endif %}
</h2>

<p><strong>Name:</strong> {{ profile.name }}</p>
<p><strong>Age:</strong> {{ profile.age }}</p>
<p><strong>Gender:</strong> {{ profile.gender }}</p>
<p><strong>Preferred Gender:</strong> {{ profile.preferred_gender }}</p>
<p><strong>Preferred Age:</strong> {{ profile.preferred_age_min }} - {{ profile.preferred_age_max }}</p>
<p><strong>City:</strong> {{ profile.location }}</p>

{% if profile.connection_types %}
<p><strong>Interested in:</strong> {{ profile.get_connection_type_labels|join:', ' }}</p>
{% endif %}

<hr>

<h2>Your Letter üíå</h2>

{% if letters %}
    {% for letter in letters %}
        <div style="border:1px solid #ccc; padding:15px; margin-bottom:20px; border-radius:10px;">
            {% if letter.letter_type == "text" %}
    {% if letter.text_content %}
        <div class="letter-card">
          <div class="letter-body">
            üìù {{ letter.text_content|linebreaksbr }}
          </div>
        </div>
    {% else %}
        <div class="letter-card"><em>No text available.</em></div>
    {% endif %}


                {% elif letter.letter_type == "pdf" and letter.pdf %}
{% with gid="p"|add:letter.id|stringformat:"s" %}
  <style>
    .pdf-card { border:1px solid #ddd;border-radius:12px;padding:12px; }
    .pdf-toolbar { display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-start;margin-bottom:10px; }
    .pdf-btn { border:1px solid #ccc;background:#f6f6f6;padding:6px 10px;border-radius:8px;cursor:pointer;line-height:1;font-size:14px; }
    .pdf-btn:disabled { opacity:.4;cursor:not-allowed; }
    .pdf-badge { font-size:13px;color:#444;min-width:56px;text-align:center; }
    .pdf-canvas-wrap { width:100%;max-height:40vh;overflow:auto;border-radius:8px;background:#fafafa;display:flex;justify-content:center;align-items:flex-start; }
    .pdf-canvas-wrap::-webkit-scrollbar { height:8px;width:8px; }
    .pdf-canvas-wrap::-webkit-scrollbar-thumb { background:#d0d0d0;border-radius:8px; }
    @media (max-width:420px){
      .pdf-card{padding:8px;border-radius:10px}
      .pdf-toolbar{gap:6px;margin-bottom:6px}
      .pdf-btn{padding:5px 8px;border-radius:7px;font-size:13px}
      .pdf-badge{font-size:12px;min-width:48px}
      .pdf-canvas-wrap{max-height:50vh}
    }
  </style>

  <div class="pdf-card" id="pdfCard-{{ gid }}">
    <div class="pdf-toolbar">
      <button type="button" class="pdf-btn" id="prev-{{ gid }}">‚óÄ</button>
      <span class="pdf-badge" id="pageLabel-{{ gid }}">1 / 1</span>
      <button type="button" class="pdf-btn" id="next-{{ gid }}">‚ñ∂</button>

      <span style="width:12px;"></span>

      <button type="button" class="pdf-btn" id="zoomOut-{{ gid }}">‚àí</button>
      <span class="pdf-badge" id="zoomLabel-{{ gid }}">100%</span>
      <button type="button" class="pdf-btn" id="zoomIn-{{ gid }}">Ôºã</button>
      <button type="button" class="pdf-btn" id="fit-{{ gid }}">Fit</button>
    </div>

    <div class="pdf-canvas-wrap">
      <canvas id="pdfCanvas-{{ gid }}"></canvas>
    </div>
  </div>

  <script>
    (function ensurePdfJs(){
      if (window.pdfjsLib) return;
      var s=document.createElement('script');
      s.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
      document.head.appendChild(s);
    })();
  </script>

  <script>
    (function initPDF{{ gid }}() {
      const url        = "{{ letter.pdf.url }}";
      const canvas     = document.getElementById('pdfCanvas-{{ gid }}');
      const ctx        = canvas.getContext('2d');
      const prevBtn    = document.getElementById('prev-{{ gid }}');
      const nextBtn    = document.getElementById('next-{{ gid }}');
      const zoomInBtn  = document.getElementById('zoomIn-{{ gid }}');
      const zoomOutBtn = document.getElementById('zoomOut-{{ gid }}');
      const fitBtn     = document.getElementById('fit-{{ gid }}');
      const zoomLabel  = document.getElementById('zoomLabel-{{ gid }}');
      const pageLabel  = document.getElementById('pageLabel-{{ gid }}');
      const dpr        = window.devicePixelRatio || 1;

      let pdfDoc=null, pageNum=1, pageCount=1, baseScale=1, scale=1, rendering=false;

      function updateLabels(){
        zoomLabel.textContent = Math.round(scale*100) + '%';
        pageLabel.textContent = pageNum + ' / ' + pageCount;
        prevBtn.disabled = (pageNum<=1);
        nextBtn.disabled = (pageNum>=pageCount);
      }

      function fitToWidth(page){
        const card = document.getElementById('pdfCard-{{ gid }}');
        const wrap = card.querySelector('.pdf-canvas-wrap');
        const available = wrap.clientWidth - 2;
        const viewport1 = page.getViewport({ scale:1 });
        baseScale = available / viewport1.width;
        scale = baseScale;
      }

      function renderPage(){
        if (rendering) return;
        rendering = true;
        pdfDoc.getPage(pageNum).then(page=>{
          if (baseScale===1) fitToWidth(page);
          const viewport = page.getViewport({ scale });
          canvas.style.width = Math.round(viewport.width)+'px';
          canvas.style.height = Math.round(viewport.height)+'px';
          canvas.width = Math.round(viewport.width*dpr);
          canvas.height = Math.round(viewport.height*dpr);
          const transform = dpr!==1 ? [dpr,0,0,dpr,0,0] : null;
          page.render({ canvasContext: ctx, viewport, transform }).promise.finally(()=>{
            rendering=false; updateLabels();
          });
        });
      }

      function start(){
        pdfjsLib.getDocument(url).promise.then(doc=>{
          pdfDoc = doc; pageCount = doc.numPages; pageNum = 1;
          renderPage();
          const card = document.getElementById('pdfCard-{{ gid }}');
          if ('ResizeObserver' in window){
            const ro = new ResizeObserver(()=>{ baseScale=1; renderPage(); });
            ro.observe(card);
          } else {
            window.addEventListener('resize', ()=>{ baseScale=1; renderPage(); });
          }
        }).catch(console.error);
      }

      function setWorker(){
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      }

      if (window.pdfjsLib){ setWorker(); start(); }
      else {
        const iv = setInterval(()=>{
          if (window.pdfjsLib){ clearInterval(iv); setWorker(); start(); }
        }, 40);
      }

      zoomInBtn.addEventListener('click', ()=>{ scale=Math.min(scale+0.15,4); renderPage(); });
      zoomOutBtn.addEventListener('click', ()=>{ scale=Math.max(scale-0.15,0.4); renderPage(); });
      fitBtn.addEventListener('click', ()=>{ baseScale=1; renderPage(); });
      prevBtn.addEventListener('click', ()=>{ if(pageNum>1){ pageNum--; renderPage(); } });
      nextBtn.addEventListener('click', ()=>{ if(pageNum<pageCount){ pageNum++; renderPage(); } });
    })();
  </script>
{% endwith %}

            

            {% elif letter.letter_type == "image" and letter.images.exists %}
                <div style="position: relative; max-width: 400px; margin-top: 10px;">
                    {% with group_id=forloop.counter %}
                        {% with images=letter.images.all %}
                            {% for image in images %}
                                <div style="display: {% if forloop.first %}block{% else %}none{% endif %};"
                                     class="slide-group-{{ group_id }}" id="slide-{{ group_id }}-{{ forloop.counter }}">
                                     <img src="{{ image.image.url }}" alt="Letter Image"
                                     class="clickable-image"
                                     style="width: 100%; border-radius: 8px; max-height: 400px; object-fit: contain; cursor: pointer;">
                                                                </div>
                            {% endfor %}

                            {% if images|length > 1 %}
                                <button onclick="prevSlide({{ group_id }}, {{ images|length }})" id="prevBtn-{{ group_id }}"
                                        style="position: absolute; left: 0; top: 45%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px;">&larr;</button>
                                <button onclick="nextSlide({{ group_id }}, {{ images|length }})" id="nextBtn-{{ group_id }}"
                                        style="position: absolute; right: 0; top: 45%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px;">&rarr;</button>
                            {% endif %}
                        {% endwith %}
                    {% endwith %}
                </div>
            {% endif %}
        </div>
    {% endfor %}
{% else %}
    <p>You have no letters uploaded yet.</p>
    <br>
    <a href="{% url 'upload_letter' %}" class="btn btn-primary">‚ûï Upload Letter</a>
{% endif %}
<a href="https://donate.stripe.com/test_aFa00l0IT2tg8z0bw7ao801" target="_blank" class="btn btn-warning" style="margin-top: 15px;">
    üíñ Support the Project
  </a>
<br><br>
<a href="{% url 'edit_profile' %}" class="btn btn-secondary">‚úèÔ∏è Edit Profile</a>
<hr style="margin: 25px 0;">

<div style="background:#f9f9f9; padding:15px; border-radius:10px; font-size:14px;">
  <p>If you run into problems or want to share feedback, reach out:</p>
  <ul style="margin:0; padding-left:18px; line-height:1.6;">
    Email: <a href="turtledatingapp@gmail.com">hello@yourdomain.com</a>
  </ul>
</div>


<script>
    const currentSlides = {};
  
    function showSlide(groupId, index, total) {
      for (let i = 1; i <= total; i++) {
        const slide = document.getElementById(`slide-${groupId}-${i}`);
        if (slide) {
          slide.style.display = (i === index) ? 'block' : 'none';
        }
      }
  
      const prevBtn = document.getElementById(`prevBtn-${groupId}`);
      const nextBtn = document.getElementById(`nextBtn-${groupId}`);
  
      if (prevBtn) prevBtn.style.display = index === 1 ? 'none' : 'block';
      if (nextBtn) nextBtn.style.display = index === total ? 'none' : 'block';
  
      currentSlides[groupId] = index;
    }
  
    function nextSlide(groupId, total) {
      if (!currentSlides[groupId]) currentSlides[groupId] = 1;
      if (currentSlides[groupId] < total) {
        currentSlides[groupId]++;
        showSlide(groupId, currentSlides[groupId], total);
      }
    }
  
    function prevSlide(groupId, total) {
      if (!currentSlides[groupId]) currentSlides[groupId] = 1;
      if (currentSlides[groupId] > 1) {
        currentSlides[groupId]--;
        showSlide(groupId, currentSlides[groupId], total);
      }
    }
  
    document.addEventListener("DOMContentLoaded", () => {
      const groups = new Set();
      document.querySelectorAll("[class^='slide-group-']").forEach(el => {
        const match = el.className.match(/slide-group-(\d+)/);
        if (match) groups.add(match[1]);
      });
  
      groups.forEach(groupId => {
        const total = document.querySelectorAll(`.slide-group-${groupId}`).length;
        showSlide(groupId, 1, total);
      });
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const pic = document.getElementById('profilePic');
      const modal = document.getElementById('picModal');
      const modalImg = document.getElementById('modalImg');
  
      if (!pic || !modal || !modalImg) return;
  
      pic.addEventListener('click', function () {
        modal.style.display = 'flex';
      });
  
      modal.addEventListener('click', function () {
        modal.style.display = 'none';
      });
    });
  </script>
  
  <script src="{% static 'js/modal_image_viewer.js' %}"></script>

{% endblock %}
