{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<h2>Edit Your Profile ‚úèÔ∏è</h2>

<form method="POST" enctype="multipart/form-data" id="profile-form">
    {% csrf_token %}
    {{ form.as_p }}

    {% if letters %}
        {% for letter in letters %}
            {% if letter.letter_type == "text" %}
                <label for="id_text_content"><strong>Letter Text Content:</strong></label><br>
                <textarea name="text_content" rows="4" style="width: 100%;">{{ letter.text_content }}</textarea>
                <input type="hidden" name="letter_id" value="{{ letter.id }}">

                <br><br>
                <a href="{% url 'delete_letter' letter.id %}" class="btn btn-sm btn-danger"
                   onclick="return confirm('Are you sure you want to delete this letter?');">
                   ‚ùå Delete Letter
                </a>

            {% elif letter.letter_type == "image" %}
                <label><strong>Your Letter Images:</strong></label><br>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
                    {% for i in "12345" %}
                        {% with index=forloop.counter0 %}
                            <div style="position: relative; width: 200px; height: 200px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center;">
                                {% if letter.images.all|length > index %}
                                    {% with img=letter.images.all|get_item:index %}
                                        {% if img %}
                                            <img src="{{ img.image.url }}" alt="Letter Image" style="max-width: 100%; max-height: 100%; border-radius: 8px;">
                                            <button type="button" class="mark-delete" data-img-id="{{ img.id }}"
                                               style="position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.8);
                                               color: white; border-radius: 50%; padding: 3px 8px; text-decoration: none;
                                               font-weight: bold; font-size: 14px; cursor: pointer;">
                                                √ó
                                            </button>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <label style="cursor: pointer;">
                                        ‚ûï
                                        <input type="file" name="images" style="display: none;">
                                    </label>
                                {% endif %}
                            </div>
                        {% endwith %}
                    {% endfor %}
                </div>
                <input type="hidden" name="delete_image_ids" id="delete_image_ids">

            {% elif letter.letter_type == "pdf" %}
                {% if letter.pdf %}
                    <p>üìÑ <a href="{{ letter.pdf.url }}" target="_blank">View PDF Letter</a></p>
                {% else %}
                    <p><em>No PDF uploaded yet.</em></p>
                {% endif %}

                <br>
                <a href="{% url 'delete_letter' letter.id %}" class="btn btn-sm btn-danger"
                   onclick="return confirm('Are you sure you want to delete this letter?');">
                   ‚ùå Delete Letter
                </a>
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if not letters %}
        <a href="{% url 'upload_letter' %}" class="btn btn-primary">‚ûï Upload Your Letter</a>
        <br><br>
    {% endif %}

    <button type="submit" class="btn btn-success">üíæ Save Changes</button>
</form>

<br>
<a href="{% url 'view_profile' %}" class="btn btn-secondary">‚Üê Back to Profile</a>

<script>
  const deleteButtons = document.querySelectorAll(".mark-delete");
  const deleteImageInput = document.getElementById("delete_image_ids");
  let deleteIds = [];

  deleteButtons.forEach(btn => {
    btn.addEventListener("click", function () {
      const imgId = this.getAttribute("data-img-id");
      deleteIds.push(imgId);
      deleteImageInput.value = deleteIds.join(",");
      this.closest("div").remove();
    });
  });
</script>
{% endblock %}
