{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<style>
  nav, .navbar, header {
    display: none !important;
  }
</style>

<h2>Edit Your Profile ✏️</h2>

<form method="POST" enctype="multipart/form-data" id="profile-form">
    {% csrf_token %}

    <p><label for="id_age">Age:</label>
      <select name="age" id="id_age">
        {% for age in ages %}
          <option value="{{ age }}" {% if form.age.value == age %}selected{% endif %}>{{ age }}</option>
        {% endfor %}
      </select>
    </p>

    <p><label for="id_gender">Gender:</label> {{ form.gender }}</p>
    <p><label for="id_profile_picture">Profile picture:</label> {{ form.profile_picture }}</p>
    <p><label for="id_preferred_gender">Preferred gender:</label> {{ form.preferred_gender }}</p>

    <p><label for="id_preferred_age_min">Preferred age min:</label>
      <select name="preferred_age_min" id="id_preferred_age_min">
        {% for age in ages %}
          <option value="{{ age }}" {% if form.preferred_age_min.value == age %}selected{% endif %}>{{ age }}</option>
        {% endfor %}
      </select>
    </p>

    <p><label for="id_preferred_age_max">Preferred age max:</label>
      <select name="preferred_age_max" id="id_preferred_age_max">
        {% for age in ages %}
          <option value="{{ age }}" {% if form.preferred_age_max.value == age %}selected{% endif %}>{{ age }}</option>
        {% endfor %}
      </select>
    </p>

    {% if letters %}
        {% for letter in letters %}
            {% if letter.letter_type == "text" %}
                <label><strong>Letter Text Content:</strong></label><br>
                <textarea name="text_content_{{ letter.id }}" rows="4" style="width: 100%;">{{ letter.text_content }}</textarea>
                <br><br>
                <a href="{% url 'delete_letter' letter.id %}" class="btn btn-sm btn-danger"
                   onclick="return confirm('Are you sure you want to delete this letter?');">
                   ❌ Delete Letter
                </a>
            {% elif letter.letter_type == "image" %}
                <label><strong>Your Letter Images:</strong></label><br>
                <div id="image-container" style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
                    {% for img in letter.images.all %}
                        <div class="image-wrapper" style="position: relative;">
                            <img src="{{ img.image.url }}" alt="Letter Image"
                                 style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px;">
                            <button type="button" class="btn btn-danger btn-sm delete-image"
                                    data-img-id="{{ img.id }}"
                                    style="position: absolute; top: 5px; right: 5px; padding: 0; width: 25px; height: 25px; border-radius: 50%;">
                                ×
                            </button>
                        </div>
                    {% endfor %}
                </div>

                <div style="margin-top: 15px;" id="upload-btn-wrapper">
                    <button type="button" id="upload-image-btn" class="btn btn-primary">
                        📄 Upload New Images
                    </button>
                    <input type="file" name="images" id="image-upload-input" multiple style="display: none;">
                </div>

                <input type="hidden" name="delete_image_ids" id="delete_image_ids">
            {% elif letter.letter_type == "pdf" %}
                {% if letter.pdf %}
                    <p>📄 <a href="{{ letter.pdf.url }}" target="_blank">View PDF Letter</a></p>
                {% else %}
                    <p><em>No PDF uploaded yet.</em></p>
                {% endif %}
                <a href="{% url 'delete_letter' letter.id %}" class="btn btn-sm btn-danger"
                   onclick="return confirm('Are you sure you want to delete this letter?');">
                   ❌ Delete Letter
                </a>
            {% endif %}
        {% endfor %}
    {% endif %}

    <!-- Show upload letter form if no letter or only image letter with no images -->
    {% if not letters or only_image_letter %}
    <div id="letter_upload_section" style="margin-top: 20px;">
        <p><strong>Add Your Letter:</strong></p>
        <p><label for="id_letter_type">Letter Type:</label> {{ letter_form.letter_type }}</p>

        <div id="text_content_div" style="display:none;">
            <label for="id_text_content">Text Content:</label><br>
            {{ letter_form.text_content }}
        </div>

        <div id="image_upload_div" style="display:none;">
            <label for="images">Upload Images:</label><br>
            <input type="file" name="images" multiple>
        </div>

        <div id="pdf_upload_div" style="display:none;">
            <label for="id_pdf">Upload PDF:</label><br>
            {{ letter_form.pdf }}
        </div>
    </div>
    {% endif %}

    <button type="submit" class="btn btn-success">🔖 Save Changes</button>
</form>

<br>
<a href="{% url 'view_profile' %}" class="btn btn-secondary">← Back to Profile</a>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const uploadInput = document.getElementById('image-upload-input');
    const uploadBtn = document.getElementById('upload-image-btn');
    const deleteIdsInput = document.getElementById('delete_image_ids');
    const imageContainer = document.getElementById('image-container');
    const letterUploadSection = document.getElementById('letter_upload_section');
    const uploadWrapper = document.getElementById('upload-btn-wrapper');
    let deleteIds = [];

    function setupLetterTypeToggle() {
        const letterTypeSelect = document.getElementById('id_letter_type');
        const textDiv = document.getElementById('text_content_div');
        const imageDiv = document.getElementById('image_upload_div');
        const pdfDiv = document.getElementById('pdf_upload_div');

        if (!letterTypeSelect) return;

        function toggleUploadFields() {
            const choice = letterTypeSelect.value;
            textDiv.style.display = (choice === 'text') ? 'block' : 'none';
            imageDiv.style.display = (choice === 'image') ? 'block' : 'none';
            pdfDiv.style.display = (choice === 'pdf') ? 'block' : 'none';
        }

        letterTypeSelect.addEventListener('change', toggleUploadFields);
        toggleUploadFields();
    }

    function checkIfNoImagesLeft() {
        const remainingImages = imageContainer ? imageContainer.querySelectorAll('.image-wrapper') : [];

        if (remainingImages.length === 0) {
            if (uploadWrapper) uploadWrapper.style.display = 'none';
            if (letterUploadSection) {
                letterUploadSection.style.display = 'block';
                setupLetterTypeToggle();
            }
        } else {
            if (uploadWrapper) uploadWrapper.style.display = 'block';
            if (letterUploadSection) letterUploadSection.style.display = 'none';
        }
    }

    document.querySelectorAll('.delete-image').forEach(btn => {
        btn.addEventListener('click', function () {
            const imgId = this.getAttribute('data-img-id');
            if (imgId) {
                deleteIds.push(imgId);
                deleteIdsInput.value = deleteIds.join(',');
            }
            this.parentElement.remove();
            setTimeout(checkIfNoImagesLeft, 50);
        });
    });

    if (uploadBtn && uploadInput) {
        uploadBtn.addEventListener('click', () => uploadInput.click());
    }

    if (uploadInput) {
        uploadInput.addEventListener('change', function () {
            Array.from(uploadInput.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'image-wrapper';
                    wrapper.style.position = 'relative';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '150px';
                    img.style.height = '150px';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '8px';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'btn btn-danger btn-sm';
                    deleteBtn.textContent = '×';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.top = '5px';
                    deleteBtn.style.right = '5px';
                    deleteBtn.style.padding = '0';
                    deleteBtn.style.width = '25px';
                    deleteBtn.style.height = '25px';
                    deleteBtn.style.borderRadius = '50%';

                    deleteBtn.onclick = () => wrapper.remove();

                    wrapper.appendChild(img);
                    wrapper.appendChild(deleteBtn);
                    if (imageContainer) {
                        imageContainer.appendChild(wrapper);
                    }
                };
                reader.readAsDataURL(file);
            });
        });
    }

    checkIfNoImagesLeft();
});
</script>
{% endblock %}
