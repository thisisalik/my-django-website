<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Letter Dating</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/base_style.css' %}">

  <style>
    /* --- Nav --- */
    .nav {
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      background:#fff;
      border-bottom:1px solid #eee;
      overflow-x:auto;                /* still safe on very small phones */
      -webkit-overflow-scrolling:touch;
      white-space:nowrap;
    }
    .nav-group {
      display:flex;
      align-items:center;
      gap:10px;
      margin:0 auto;                  /* center group */
    }
    .nav-item {
      position:relative;
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:10px;
      text-decoration:none;
      color:#374151;
      font-weight:500;
      flex:0 0 auto;
    }
    .nav-item:hover { background:#f6f7f8; }
    .nav-item.active { background:#eef6ff; color:#1d4ed8; }
    .nav-item .icon { font-size:22px; line-height:1; }
    .nav-item .label { font-size:14px; }

    .badge {
      position:absolute;
      top:-4px;
      right:-4px;
      background:#ef4444;
      color:#fff;
      border-radius:999px;
      font-size:11px;
      padding:2px 6px;
      line-height:1;
      display:none;
    }

    .avatar {
      width:28px;
      height:28px;
      border-radius:50%;
      object-fit:cover;
      border:1px solid #e5e7eb;
    }

    @media (max-width:560px){
      .nav { justify-content:center; gap:8px; }
      .nav-group { gap:6px; }
      .nav-item { padding:8px 8px; }
      .nav-item .label { font-size:13px; }
    }

    /* small footer logout at bottom of page */
    .logout-footer {
      display:flex;
      justify-content:center;
      padding:12px 0 18px;
    }
    .logout-footer button {
      border-radius:999px;
      padding:8px 16px;
      border:none;
      background:#e5e7eb;
      color:#111827;
      cursor:pointer;
      font-size:0.95rem;
    }
    .logout-footer button:hover {
      background:#d1d5db;
    }
  </style>
</head>

<body>
  <nav class="nav">
    <div class="nav-group">
      <!-- Browse Letters -->
      <a href="/letters/"
         class="nav-item {% if request.path|slice:':8' == '/letters' %}active{% endif %}"
         title="Browse Letters" aria-label="Browse Letters">
        <span class="icon" aria-hidden="true">üíå</span>
        <span class="label">Letters</span>
      </a>

      <!-- Likes (üê¢) -->
      <a href="/likes/"
         class="nav-item {% if request.path|slice:':6' == '/likes' %}active{% endif %}"
         id="likes-icon"
         title="Likes" aria-label="Likes">
        <span class="icon" aria-hidden="true">üê¢</span>
        <span class="label">Likes</span>
        <span id="likes-count" class="badge"></span>
      </a>

      <!-- Chats -->
      <a href="/chats/"
         class="nav-item {% if request.path|slice:':6' == '/chats' %}active{% endif %}"
         id="messages-icon"
         title="Chats" aria-label="Chats">
        <span class="icon" aria-hidden="true">üí¨</span>
        <span class="label">Chats</span>
        <span id="messages-count" class="badge"></span>
      </a>

      <!-- Profile -->
      <a href="/profile/"
         class="nav-item {% if request.path == '/profile/' %}active{% endif %}"
         title="My Profile" aria-label="My Profile">
        {% if request.user.is_authenticated and request.user.profile.profile_picture %}
          <img src="{{ request.user.profile.profile_picture.url }}" alt="Profile" class="avatar">
        {% else %}
          <span class="icon" aria-hidden="true">üë§</span>
        {% endif %}
        <span class="label">Profile</span>
      </a>
    </div>
  </nav>

  <div class="container">
    {% block content %}{% endblock %}
  </div>

  {% if request.user.is_authenticated %}
    <div class="logout-footer">
      <form action="/accounts/logout/" method="post" style="margin:0;">
        {% csrf_token %}
        <button type="submit" title="Logout">Logout</button>
      </form>
    </div>
  {% endif %}

  <script>
    function updateNotifications() {
      fetch('/notifications/live/')
        .then(r => r.json())
        .then(data => {
          const likes = data.new_likes_count || 0;
          const msgs = (data.unread_messages_count || 0) + (data.unseen_matches_count || 0);

          const likesSpan = document.getElementById('likes-count');
          const messagesSpan = document.getElementById('messages-count');

          if (likes > 0) { likesSpan.textContent = likes; likesSpan.style.display = 'inline'; }
          else { likesSpan.style.display = 'none'; }

          if (msgs > 0) { messagesSpan.textContent = msgs; messagesSpan.style.display = 'inline'; }
          else { messagesSpan.style.display = 'none'; }
        })
        .catch(() => {});
    }
    setInterval(updateNotifications, 5000);
    updateNotifications();
  </script>

  <script>
    (function () {
      try {
        var tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (tz) document.cookie = "timezone=" + encodeURIComponent(tz) + "; Max-Age=31536000; Path=/";
      } catch (e) {}
    })();
  </script>
</body>
</html>