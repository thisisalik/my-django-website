{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
  nav, .navbar, header {
    display: none !important;
  }
</style>

<h2>Create Account</h2>
{% if request.method == "POST" and messages %}
  <div style="margin: 10px 0;">
    {% for message in messages %}
      <div style="padding:10px;border-radius:8px; margin-bottom:8px;
                  {% if message.tags == 'error' %}background:#ffe8e8;color:#b00020;border:1px solid #f5b5b5;
                  {% elif message.tags == 'success' %}background:#eaf8ea;color:#1b7a1b;border:1px solid #b7e1b7;
                  {% else %}background:#f1f1f1;color:#333;border:1px solid #ddd;{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<div style="margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 10px;">
    <strong>Connect through emotion ‚Äî not just photos.</strong><br><br>
    On this platform, you share a <strong>letter about yourself</strong>:<br>
    ‚úçÔ∏è Type it directly on the site,<br>
    üì∑ Take a picture of a handwritten one and upload it,<br>
    üìÑ Or upload it as a PDF.<br><br>
    You‚Äôll be shown other people‚Äôs letters ‚Äî and you match only if there‚Äôs mutual interest.<br>
    After matching, you can view each other's profile and start chatting.<br><br>
    <em>It‚Äôs a slower, more meaningful way to connect ‚Äî one letter at a time.</em>
  </div>
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.non_field_errors }}
  {% if form.errors %}
  <div style="margin:10px 0;padding:10px;border:1px solid #f5b5b5;background:#ffe8e8;border-radius:8px;">
    <strong>There are errors in your submission:</strong>
    {{ form.errors }}
  </div>
{% endif %}

  <p><label for="id_name">Name:</label> {{ form.name }}</p>
  <p>
    <label for="id_email">Email:</label>
    {{ form.email }}
    {% if form.email.errors %}
      <div style="color: red; margin-top: 5px;">{{ form.email.errors.0 }}</div>
    {% endif %}
  </p>  <p><label for="id_password1">Password:</label> {{ form.password1 }}</p>
  <p><label for="id_password2">Confirm Password:</label> {{ form.password2 }}</p>

  <p><label for="id_age">Age:</label>
    <select name="age" id="id_age">
      {% for age in ages %}
        <option value="{{ age }}">{{ age }}</option>
      {% endfor %}
    </select>
  </p>

  <p><label for="id_gender">Gender:</label> {{ form.gender }}</p>
  <p>
    {{ form.profile_picture.label_tag }}
    {{ form.profile_picture }}
    {% for error in form.profile_picture.errors %}
      <div style="color: red; margin-top: 5px;">{{ error }}</div>
    {% endfor %}
  </p>
  <input type="hidden" name="temp_profile_picture" value="{{ temp_profile_picture|default:'' }}">
  {% if temp_profile_picture %}
  <div style="margin-top:6px">
    <img src="/media/{{ temp_profile_picture }}" alt="Selected profile picture"
         style="max-width:140px;border-radius:10px;border:1px solid #ddd;">
    <div style="font-size:12px;color:#555;margin-top:4px;">
      We‚Äôll use this picture unless you choose another.
    </div>
  </div>
{% endif %}

  <p><label for="id_preferred_gender">Preferred Gender:</label> {{ form.preferred_gender }}</p>

  <p><label for="id_preferred_age_min">Preferred Minimum Age:</label>
    <select name="preferred_age_min" id="id_preferred_age_min">
      {% for age in ages %}
        <option value="{{ age }}">{{ age }}</option>
      {% endfor %}
    </select>
  </p>

  <p><label for="id_preferred_age_max">Preferred Maximum Age:</label>
    <select name="preferred_age_max" id="id_preferred_age_max">
      {% for age in ages %}
        <option value="{{ age }}">{{ age }}</option>
      {% endfor %}
    </select>
  </p>

  <p>
    <label for="id_location">City:</label>
    <input type="text" name="location" id="id_location" value="{{ form.location.value|default_if_none:'' }}" autocomplete="off" />
    
    {% if form.location.errors %}
      <div style="color: red; margin-top: 5px;">{{ form.location.errors.0 }}</div>
    {% endif %}
    
    <div id="city-suggestions" style="border: 1px solid #ccc; display:none; position: absolute; background: white; z-index: 10;"></div>
  </p>
  
  <div style="margin-top: -10px; margin-bottom: 10px;">
    {% for checkbox in form.only_same_city %}
      <label style="display: block;">{{ checkbox.tag }} {{ checkbox.choice_label }}</label>
    {% endfor %}
  </div>
  <p style="margin-top: 20px;"><strong>Connection type:</strong></p>
    {% for checkbox in form.connection_types %}
      <label style="display: block;">{{ checkbox.tag }} {{ checkbox.choice_label }}</label>
    {% endfor %}
    <!-- ‚úÖ Show error if none selected -->
{% if form.connection_types.errors %}
<div style="color: red; margin-bottom: 5px;">{{ form.connection_types.errors.0 }}</div>
{% endif %}
<p><strong>Add Your Letter:</strong></p>

    </ul>
  <p style="font-size: 14px; color: #555;">
    Your letter is the only thing others will see at first ‚Äî so take your time and share something that feels real. ‚ú®
    <li><strong>Text</strong> ‚Äî write directly in the box below.</li>
    <li><strong>Image </strong> ‚Äî upload a clear photo of your handwritten letter.</li>
    <li><strong>PDF</strong> ‚Äî upload a typed letter you saved as a file.</li>
  </p>
  
  <!-- ‚úÖ Add Your Letter section with toggle -->
  <p>
    <input type="checkbox" id="skip_upload_checkbox" name="skip_letter" value="1">
<label for="skip_upload_checkbox">I‚Äôll upload my letter later</label>

  </p>

  <div id="letter_upload_section">
    <p><label for="id_letter_type">Letter Type:</label> {{ form.letter_type }}</p>

    <div id="text_content_div" style="display:none;">
      <label for="id_text_content">Text Content:</label><br>
      {{ form.text_content }}
      <small id="letter_help" style="display:block;margin-top:6px;color:#555;">
        Minimum <strong>200</strong> characters, maximum <strong>2000</strong>. 
        <span id="char_count">0</span>/<span id="char_max">2000</span>
      </small>
      
    </div>

    <div id="image_upload_div" style="display:none;">
      <label for="images">Upload Images:</label><br>
      <input type="file" id="id_letter_images" name="images" multiple accept="image/*">
    </div>

    <div id="pdf_upload_div" style="display:none;">
      <label for="id_pdf">Upload PDF:</label><br>
      <input type="file" name="pdf" id="id_pdf" accept=".pdf,application/pdf">
      {% if form.pdf.errors %}
        <div style="color:red; margin-top:5px;">{{ form.pdf.errors.0 }}</div>
      {% endif %}
          </div>
    <br>
  </div>
  <p style="margin-top: 15px;">
    <label for="id_agree_to_share">
      {{ form.agree_to_share }} {{ form.agree_to_share.label }}
    </label>
    {% if form.agree_to_share.errors %}
      <div style="color: red; margin-top: 5px;">{{ form.agree_to_share.errors.0 }}</div>
    {% endif %}
  </p>

  <br><br>
  <button type="submit" class="btn btn-success" id="registerBtn" disabled>üìù Register</button>
</form>

<p style="margin-top: 20px;">Already have an account? <a href="/accounts/login/">Login</a></p>
<script src="{% static '/js/city_autocomplete.js' %}?v={{ timestamp }}"></script>

  
<script>
  const letterTypeSelect = document.getElementById('id_letter_type');
  const textDiv = document.getElementById('text_content_div');
  const imageDiv = document.getElementById('image_upload_div');
  const pdfDiv = document.getElementById('pdf_upload_div');
  const skipCheckbox = document.getElementById('skip_upload_checkbox');
  const letterUploadSection = document.getElementById('letter_upload_section');

  function toggleUploadFields() {
    const choice = letterTypeSelect.value;
    textDiv.style.display = (choice === 'text') ? 'block' : 'none';
    imageDiv.style.display = (choice === 'image') ? 'block' : 'none';
    pdfDiv.style.display = (choice === 'pdf') ? 'block' : 'none';
  }

  function toggleLetterUploadVisibility() {
    letterUploadSection.style.display = skipCheckbox.checked ? 'none' : 'block';
  }

  if (letterTypeSelect) {
    letterTypeSelect.addEventListener('change', toggleUploadFields);
    toggleUploadFields();
  }

  if (skipCheckbox) {
    skipCheckbox.addEventListener('change', toggleLetterUploadVisibility);
    toggleLetterUploadVisibility();
  }

  document.querySelector('form').addEventListener('submit', function (e) {
    const connectionTypes = document.querySelectorAll("input[name='connection_types']:checked");
    if (connectionTypes.length === 0) {
      e.preventDefault();
      alert("‚ùå Please select at least one interest (e.g., Dating, Friendship, etc.).");
      return false;
    }

    if (!skipCheckbox.checked) {
      const letterType = letterTypeSelect.value;
      const textInput = document.getElementById('id_text_content');

      if (letterType === 'text' && textInput && textInput.value.trim().length < 4) {
        e.preventDefault();
        alert("‚ùå Letter text must be at least 4 characters long.");
        textInput.focus();
        return false;
      }
    }
  });

</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const minSelect = document.getElementById('id_preferred_age_min');
        const maxSelect = document.getElementById('id_preferred_age_max');
    
        function updateMaxOptions() {
            const minAge = parseInt(minSelect.value);
            Array.from(maxSelect.options).forEach(option => {
                const val = parseInt(option.value);
                option.disabled = val <= minAge;
            });
            // Auto-select valid value if current value invalid
            if (parseInt(maxSelect.value) <= minAge) {
                maxSelect.value = "";
            }
        }
    
        function updateMinOptions() {
            const maxAge = parseInt(maxSelect.value);
            Array.from(minSelect.options).forEach(option => {
                const val = parseInt(option.value);
                option.disabled = val >= maxAge;
            });
            if (parseInt(minSelect.value) >= maxAge) {
                minSelect.value = "";
            }
        }
    
        if (minSelect && maxSelect) {
            minSelect.addEventListener('change', updateMaxOptions);
            maxSelect.addEventListener('change', updateMinOptions);
            updateMaxOptions();
            updateMinOptions();
        }
    });
    </script>
<script>
    (function () {
      const btn = document.getElementById('registerBtn');
    
      const cityInput = document.getElementById('id_location');
      const agreeCheckbox = document.getElementById('id_agree_to_share');
      const skipCheckbox = document.getElementById('skip_upload_checkbox');
      const letterTypeSelect = document.getElementById('id_letter_type');
      const textInput = document.getElementById('id_text_content');
      const imagesInput = document.querySelector("input[name='images']");
      const pdfInput = document.getElementById('id_pdf');
      const pwd1 = document.getElementById('id_password1');
      const pwd2 = document.getElementById('id_password2');
    
      // Place to show password mismatch error
      let pwdError = document.createElement('div');
      pwdError.style.color = 'red';
      pwdError.style.marginTop = '5px';
      if (pwd2 && !pwd2.nextElementSibling) {
        pwd2.parentNode.appendChild(pwdError);
      }
    
      function connectionTypesOk() {
        return document.querySelectorAll("input[name='connection_types']:checked").length > 0;
      }
    
      function nonEmpty(v){ return !!(v && v.trim().length); }
    
      function letterValid() {
        if (skipCheckbox && skipCheckbox.checked) return true;
    
        if (!letterTypeSelect || !nonEmpty(letterTypeSelect.value)) return false;
        const t = letterTypeSelect.value;
    
        if (t === 'text') {
          return !!(textInput && textInput.value.trim().length >= 4);
        } else if (t === 'image') {
          return !!(imagesInput && imagesInput.files && imagesInput.files.length > 0);
        } else if (t === 'pdf') {
          return !!(pdfInput && pdfInput.files && pdfInput.files.length > 0);
        }
        return false;
      }
    
      function passwordsMatch() {
        if (!pwd1 || !pwd2) return false;
        if (pwd1.value === '' || pwd2.value === '') return false;
        return pwd1.value === pwd2.value;
      }
    
      function requirementsMet() {
        const cityOk = !!(cityInput && nonEmpty(cityInput.value));
        const agreeOk = !!(agreeCheckbox && agreeCheckbox.checked);
        const connOk = connectionTypesOk();
        const letterOk = letterValid();
        const pwdOk = passwordsMatch();
        return cityOk && agreeOk && connOk && letterOk && pwdOk;
      }
    
      function updateBtn() {
        const ok = requirementsMet();
    
        // show / hide password mismatch error
        if (pwd1 && pwd2 && pwdError) {
          if (pwd1.value && pwd2.value && pwd1.value !== pwd2.value) {
            pwdError.textContent = "‚ùå Passwords do not match.";
          } else {
            pwdError.textContent = "";
          }
        }
    
        btn.disabled = !ok;
        btn.style.opacity = ok ? '' : '0.6';
        btn.style.cursor = ok ? '' : 'not-allowed';
      }
    
      function listen(el, ev) { if (el) el.addEventListener(ev, updateBtn); }
    
      document.addEventListener('DOMContentLoaded', function () {
        listen(cityInput, 'input');
        listen(agreeCheckbox, 'change');
        listen(skipCheckbox, 'change');
        listen(letterTypeSelect, 'change');
        listen(textInput, 'input');
        listen(imagesInput, 'change');
        listen(pdfInput, 'change');
        listen(pwd1, 'input');
        listen(pwd2, 'input');
        document.querySelectorAll("input[name='connection_types']").forEach(el => {
          el.addEventListener('change', updateBtn);
        });
        updateBtn(); // initial
      });
    
      document.querySelector('form').addEventListener('submit', function (e) {
        if (!requirementsMet()) {
          e.preventDefault();
          alert("‚ùå Please complete all required fields: City, Connection type, Agree, Letter, and matching Passwords.");
        }
      });
    })();
    </script>
<script>
  (function () {
    const MIN_CHARS = 200;
    const MAX_CHARS = 2000;
  
    const textarea = document.getElementById('id_text_content');
    const letterTypeSelect = document.getElementById('id_letter_type');
    const skipCheckbox = document.getElementById('skip_upload_checkbox');
    const counter = document.getElementById('char_count');
    const maxOut = document.getElementById('char_max');
    const help = document.getElementById('letter_help');
  
    // setup once
    if (maxOut) maxOut.textContent = String(MAX_CHARS);
    if (textarea) {
      textarea.setAttribute('maxlength', String(MAX_CHARS));
      if (!textarea.getAttribute('rows')) {
        textarea.setAttribute('rows', '6');
      }
    }
  
    function visibleAndTextMode() {
      return letterTypeSelect && letterTypeSelect.value === 'text' && !(skipCheckbox && skipCheckbox.checked);
    }
  
    function updateCounter() {
      if (!textarea || !counter) return;
      const len = (textarea.value || '').trim().length;
      counter.textContent = String(len);
  
      if (help) {
        help.style.color = (visibleAndTextMode() && len > 0 && len < MIN_CHARS) ? '#b00020' : '#555';
      }
    }
  
    // --- unified validator, replaces all older ones ---
    window.letterValid = function () {
      const tSel = document.getElementById('id_letter_type');
      const tInput = document.getElementById('id_text_content');
      const imagesInput = document.querySelector("input[name='images']");
      const pdfInput = document.getElementById('id_pdf');
      const skip = document.getElementById('skip_upload_checkbox');
  
      if (skip && skip.checked) return true;
      if (!tSel || !tSel.value) return false;
  
      const t = tSel.value;
      if (t === 'text') {
        return !!(tInput && (tInput.value || '').trim().length >= MIN_CHARS);
      } else if (t === 'image') {
        return !!(imagesInput && imagesInput.files && imagesInput.files.length > 0);
      } else if (t === 'pdf') {
        return !!(pdfInput && pdfInput.files && pdfInput.files.length > 0);
      }
      return false;
    };
  
    // --- counter events ---
    if (textarea) {
      textarea.addEventListener('input', updateCounter);
    }
    if (letterTypeSelect) letterTypeSelect.addEventListener('change', updateCounter);
    if (skipCheckbox) skipCheckbox.addEventListener('change', updateCounter);
    updateCounter();
  
    // --- submit-time guard ---
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function (e) {
        const tSel = document.getElementById('id_letter_type');
        const tInput = document.getElementById('id_text_content');
        const skip = document.getElementById('skip_upload_checkbox');
  
        if (!skip.checked && tSel && tSel.value === 'text') {
          const len = (tInput && tInput.value || '').trim().length;
          if (len < MIN_CHARS) {
            e.preventDefault();
            alert(`‚ùå Letter text must be at least ${MIN_CHARS} characters (you have ${len}).`);
            tInput && tInput.focus();
            return false;
          }
        }
      });
    }
  })();
  </script>
  
  <script>
    /**
     * Client-side image compressor
     * - downscales to max 1600px
     * - saves as JPEG ~82% quality
     * - if the browser can't compress, it falls back to the original file
     */
    async function compressFile(file, maxSide = 1600, quality = 0.82) {
      if (!file || !file.type?.startsWith('image/')) return file;
    
      // Skip tiny JPEGs
      if (/jpe?g$/i.test(file.name) && file.size < 1.2 * 1024 * 1024) return file;
    
      // Decode image
      const bmp = await (window.createImageBitmap
        ? createImageBitmap(file)
        : new Promise((res, rej) => {
            const img = new Image();
            img.onload = () => res(img);
            img.onerror = rej;
            img.src = URL.createObjectURL(file);
          })
      ).catch(() => null);
      if (!bmp) return file;
    
      // Scale
      const scale = Math.min(1, maxSide / Math.max(bmp.width, bmp.height));
      const w = Math.round(bmp.width * scale);
      const h = Math.round(bmp.height * scale);
    
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bmp, 0, 0, w, h);
    
      const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', quality));
      if (!blob) return file;
    
      const filename = (file.name.replace(/\.\w+$/, '') || 'photo') + '.jpg';
      return new File([blob], filename, { type: 'image/jpeg' });
    }
    
    function replaceFiles(input, files) {
      const dt = new DataTransfer();
      (Array.isArray(files) ? files : [files]).forEach(f => dt.items.add(f));
      input.files = dt.files;
    }
    
    function wireCompressorFor(input) {
      if (!input) return;
      // Make sure file picker shows images
      if (!input.accept?.includes('image/')) input.accept = 'image/*';
      input.addEventListener('change', async (e) => {
        if (!e.target.files?.length) return;
        if (input.multiple) {
          const out = [];
          for (const f of e.target.files) out.push(await compressFile(f));
          replaceFiles(input, out);
        } else {
          const f = await compressFile(e.target.files[0]);
          replaceFiles(input, f);
        }
      });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      // Profile picture (Django default id for ImageField)
      const profilePic = document.querySelector('#id_profile_picture, input[name="profile_picture"]');
      wireCompressorFor(profilePic);
    
      // Letter images (we set id above)
      const letterImgs = document.querySelector('#id_letter_images, input[name="images"]');
      wireCompressorFor(letterImgs);
    });
    </script>
    
      
{% endblock %}
