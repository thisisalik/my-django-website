{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  /* Make content + logout sit closer together on this page */
  .container {
    max-width: 960px;
    margin: 12px auto 0;
    padding: 0 16px 4px;
  }
  .logout-bar {
    margin-top: 10px !important;
    margin-bottom: 10px !important;
  }

  /* Compact event card */
  .event-card {
    background: #ffffff;
    border-radius: 18px;
    padding: 10px 14px 12px;
    margin: 10px 0 6px;
    box-shadow: 0 4px 14px rgba(15, 23, 42, 0.06);
    border: 1px solid #e5e7eb;
  }
  .event-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .event-row label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
    font-size: 0.95rem;
  }
  .event-name {
    font-weight: 600;
  }
  .event-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 6px;
  }
  .event-chip {
    border-radius: 999px;
    padding: 6px 14px;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
  }
  .event-chip.primary {
    background: #111827;
    color: #fff;
  }
  .event-chip.secondary {
    background: #e5e7eb;
    color: #111827;
    text-decoration: none;
  }
  .event-note {
    margin-top: 4px;
    font-size: 0.82rem;
    color: #4b5563;
  }

  /* Letter card already has base style (.letter-card), just tighten a bit */
  .letter-card {
    margin: 10px 0 8px;
  }

  /* Make image letters nice and big again */
  .letter-image-wrapper {
    max-width: 100%;
    margin-top: 6px;
  }
  .letter-image-wrapper img {
    width: 100%;
    max-height: 380px;   /* similar to what you had before */
    border-radius: 14px;
    object-fit: contain;
  }

  /* Like / Skip buttons row */
  .browse-actions {
    display: flex;
    justify-content: center;
    gap: 18px;
    margin: 10px 0 0;
  }

  /* PDF viewer ‚Äì shorter + cleaner */
  .pdf-card {
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 8px 10px 10px;
    box-shadow: 0 4px 14px rgba(15, 23, 42, 0.04);
    background: #ffffff;
  }
  .pdf-toolbar {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 4px;
    font-size: 13px;
  }
  .pdf-btn {
    border: 1px solid #d1d5db;
    background: #f3f4f6;
    padding: 4px 8px;
    border-radius: 9px;
    cursor: pointer;
    font-size: 12px;
    line-height: 1;
  }
  .pdf-btn:disabled {
    opacity: .4;
    cursor: not-allowed;
  }
  .pdf-badge {
    font-size: 12px;
    min-width: 46px;
    text-align: center;
    color: #374151;
  }
  .pdf-canvas-wrap {
    width: 100%;
    max-height: 32vh;          /* MUCH shorter */
    overflow: auto;
    border-radius: 10px;
    background: #f9fafb;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }
  .pdf-canvas-wrap::-webkit-scrollbar {
    height: 6px;
    width: 6px;
  }
  .pdf-canvas-wrap::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 999px;
  }

  @media (max-width: 480px) {
    .pdf-canvas-wrap {
      max-height: 28vh;        /* even shorter on small phones */
    }
  }
</style>

{% if request.user.is_authenticated and request.user.profile.active_event %}
  <div class="event-card">
    <form method="post" action="{% url 'toggle_event_mode' %}">
      {% csrf_token %}
      <div class="event-row">
        <label>
          <input
            type="checkbox"
            name="limit_to_event_pool"
            value="1"
            {% if request.user.profile.limit_to_event_pool %}checked{% endif %}
          >
          <span>Only show letters from the event:</span>
          <span class="event-name">{{ request.user.profile.active_event.name }}</span>
        </label>
      </div>

      <div class="event-actions">
        <button type="submit" class="event-chip primary">Update</button>
        <a href="{% url 'join_event' %}" class="event-chip secondary">Change event</a>
      </div>

      <p class="event-note">
        You can switch the event anytime ‚Äî this only affects which letters you see.
      </p>
    </form>
  </div>
{% endif %}

<h2>Browse Letters üíå</h2>

{% if letter %}
  <div class="letter-card">
    {% if letter.letter_type == "text" %}
      {% if letter.text_content %}
        <div class="letter-body">
          üìù {{ letter.text_content|linebreaksbr }}
        </div>
      {% else %}
        <em>No text available.</em>
      {% endif %}

    {% elif letter.letter_type == "image" %}
      <div class="letter-image-wrapper">
        <div style="position: relative; max-width: 100%; margin-top: 4px;">
          {% with group_id="browse" %}
            {% with images=letter.images.all %}
              {% for image in images %}
                <div style="display: {% if forloop.first %}block{% else %}none{% endif %};"
                     class="slide-group-{{ group_id }}" id="slide-{{ group_id }}-{{ forloop.counter }}">
                  <img src="{{ image.image.url }}" alt="Letter Image"
                       class="clickable-image">
                </div>
              {% endfor %}

              {% if images|length > 1 %}
                <button onclick="prevSlide('{{ group_id }}', {{ images|length }})" id="prevBtn-{{ group_id }}"
                        style="position: absolute; left: 6px; top: 50%; transform: translateY(-50%);
                               background: rgba(0,0,0,0.55); color: white; border: none;
                               padding: 8px 10px; border-radius: 999px;">‚üµ</button>
                <button onclick="nextSlide('{{ group_id }}', {{ images|length }})" id="nextBtn-{{ group_id }}"
                        style="position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
                               background: rgba(0,0,0,0.55); color: white; border: none;
                               padding: 8px 10px; border-radius: 999px;">‚ü∂</button>
              {% endif %}
            {% endwith %}
          {% endwith %}
        </div>
      </div>

    {% elif letter.letter_type == "pdf" and letter.pdf %}
      {% with gid="browse" %}
        <div class="pdf-card" id="pdfCard-{{ gid }}">
          <div class="pdf-toolbar">
            <button type="button" class="pdf-btn" id="prev-{{ gid }}">‚óÄ</button>
            <span class="pdf-badge" id="pageLabel-{{ gid }}">1 / 1</span>
            <button type="button" class="pdf-btn" id="next-{{ gid }}">‚ñ∂</button>

            <span style="width:8px;"></span>

            <button type="button" class="pdf-btn" id="zoomOut-{{ gid }}">‚àí</button>
            <span class="pdf-badge" id="zoomLabel-{{ gid }}">100%</span>
            <button type="button" class="pdf-btn" id="zoomIn-{{ gid }}">Ôºã</button>
            <button type="button" class="pdf-btn" id="fit-{{ gid }}">Fit</button>
          </div>

          <div class="pdf-canvas-wrap">
            <canvas id="pdfCanvas-{{ gid }}"></canvas>
          </div>
        </div>

        <!-- Load pdf.js once -->
        <script>
          (function ensurePdfJs(){
            if (window.pdfjsLib) return;
            var s=document.createElement('script');
            s.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
            document.head.appendChild(s);
          })();
        </script>

        <script>
          (function initPDF{{ gid }}() {
            const url        = "{{ letter.pdf.url }}";
            const canvas     = document.getElementById('pdfCanvas-{{ gid }}');
            const ctx        = canvas.getContext('2d');
            const prevBtn    = document.getElementById('prev-{{ gid }}');
            const nextBtn    = document.getElementById('next-{{ gid }}');
            const zoomInBtn  = document.getElementById('zoomIn-{{ gid }}');
            const zoomOutBtn = document.getElementById('zoomOut-{{ gid }}');
            const fitBtn     = document.getElementById('fit-{{ gid }}');
            const zoomLabel  = document.getElementById('zoomLabel-{{ gid }}');
            const pageLabel  = document.getElementById('pageLabel-{{ gid }}');
            const dpr        = window.devicePixelRatio || 1;

            let pdfDoc=null, pageNum=1, pageCount=1, baseScale=1, scale=1, rendering=false;

            function updateLabels(){
              zoomLabel.textContent = Math.round(scale*100) + '%';
              pageLabel.textContent = pageNum + ' / ' + pageCount;
              prevBtn.disabled = (pageNum<=1);
              nextBtn.disabled = (pageNum>=pageCount);
            }

            function fitToWidth(page){
              const card = document.getElementById('pdfCard-{{ gid }}');
              const wrap = card.querySelector('.pdf-canvas-wrap');
              const available = wrap.clientWidth - 2;
              const viewport1 = page.getViewport({ scale:1 });

              // Limit height so PDF block isn't super tall
              const maxH   = (window.innerHeight || 700) * 0.33;  // ‚âà 33vh
              const byW    = available / viewport1.width;
              const byH    = maxH / viewport1.height;
              baseScale    = Math.min(byW, byH);
              scale        = baseScale;
            }

            function renderPage(){
              if (rendering) return;
              rendering = true;
              pdfDoc.getPage(pageNum).then(page=>{
                if (baseScale===1) fitToWidth(page);
                const viewport = page.getViewport({ scale });
                canvas.style.width  = Math.round(viewport.width)+'px';
                canvas.style.height = Math.round(viewport.height)+'px';
                canvas.width  = Math.round(viewport.width*dpr);
                canvas.height = Math.round(viewport.height*dpr);
                const transform = dpr!==1 ? [dpr,0,0,dpr,0,0] : null;
                page.render({ canvasContext: ctx, viewport, transform }).promise.finally(()=>{
                  rendering=false; updateLabels();
                });
              });
            }

            function start(){
              pdfjsLib.getDocument(url).promise.then(doc=>{
                pdfDoc = doc; pageCount = doc.numPages; pageNum = 1;
                renderPage();
                const card = document.getElementById('pdfCard-{{ gid }}');
                if ('ResizeObserver' in window){
                  const ro = new ResizeObserver(()=>{ baseScale=1; renderPage(); });
                  ro.observe(card);
                } else {
                  window.addEventListener('resize', ()=>{ baseScale=1; renderPage(); });
                }
              }).catch(console.error);
            }

            function setWorker(){
              pdfjsLib.GlobalWorkerOptions.workerSrc =
                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
            }

            if (window.pdfjsLib){ setWorker(); start(); }
            else {
              const iv = setInterval(()=>{
                if (window.pdfjsLib){ clearInterval(iv); setWorker(); start(); }
              }, 40);
            }

            // controls
            zoomInBtn.addEventListener('click', ()=>{ scale=Math.min(scale+0.15,4); renderPage(); });
            zoomOutBtn.addEventListener('click', ()=>{ scale=Math.max(scale-0.15,0.4); renderPage(); });
            fitBtn.addEventListener('click', ()=>{ baseScale=1; renderPage(); });
            prevBtn.addEventListener('click', ()=>{ if(pageNum>1){ pageNum--; renderPage(); } });
            nextBtn.addEventListener('click', ()=>{ if(pageNum<pageCount){ pageNum++; renderPage(); } });
          })();
        </script>
      {% endwith %}
    {% endif %}
  </div>

  <div class="browse-actions">
    <form method="post" action="{% url 'react_to_letter' letter.id %}">
      {% csrf_token %}
      <button name="liked" value="true" class="btn btn-primary">‚ù§Ô∏è Like</button>
      <button name="liked" value="false" class="btn btn-primary" style="background:#2563eb;">‚ùå Skip</button>
    </form>
  </div>

{% else %}
  <p>No more letters available. Try again later.</p>
{% endif %}

<script src="{% static 'js/modal_image_viewer.js' %}"></script>
<script>
  const currentSlides = {};

  function showSlide(groupId, index, total) {
    for (let i = 1; i <= total; i++) {
      const slide = document.getElementById(`slide-${groupId}-${i}`);
      if (slide) {
        slide.style.display = (i === index) ? 'block' : 'none';
      }
    }

    const prevBtn = document.getElementById(`prevBtn-${groupId}`);
    const nextBtn = document.getElementById(`nextBtn-${groupId}`);

    if (prevBtn) prevBtn.style.display = index === 1 ? 'none' : 'block';
    if (nextBtn) nextBtn.style.display = index === total ? 'none' : 'block';

    currentSlides[groupId] = index;
  }

  function nextSlide(groupId, total) {
    if (!currentSlides[groupId]) currentSlides[groupId] = 1;
    if (currentSlides[groupId] < total) {
      currentSlides[groupId]++;
      showSlide(groupId, currentSlides[groupId], total);
    }
  }

  function prevSlide(groupId, total) {
    if (!currentSlides[groupId]) currentSlides[groupId] = 1;
    if (currentSlides[groupId] > 1) {
      currentSlides[groupId]--;
      showSlide(groupId, currentSlides[groupId], total);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const groupId = "browse";
    const total = document.querySelectorAll(`.slide-group-${groupId}`).length;
    if (total > 0) {
      showSlide(groupId, 1, total);
    }
  });
</script>

{% endblock %}
