{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  /* Make this page tighter vertically */
  .container {
    min-height: auto;
    padding-bottom: 6px;
  }

  /* Event card ‚Äì short & compact */
  .event-card {
    margin: 6px 0 8px;
    padding: 8px 10px;
    font-size: 0.9rem;
  }
  .event-card form {
    margin: 0;
  }
  .event-toggle-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 4px;
  }
  .event-toggle-row label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
    margin: 0;
  }
  .event-toggle-row strong {
    margin-left: 4px;
  }
  .event-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin: 2px 0 0;
  }
  .event-note {
    display: none;
  }

  .event-card .btn {
    border-radius: 999px;
    padding: 5px 14px;
    font-size: 0.85rem;
    border: none;
    cursor: pointer;
  }
  .event-card .btn-primary {
    background: #020617;
    color: #fff;
  }
  .event-card .btn-secondary {
    background: #e5e7eb;
    color: #111827;
  }

  /* Browse title spacing */
  h2 {
    margin: 10px 0 10px;
  }

  /* Letter card ‚Äì fixed height, no bottom gap */
  .letter-card {
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:18px;
    box-shadow:0 8px 24px rgba(15,23,42,0.06);
    padding:12px 14px;

    margin:10px 0 0;     /* ‚úÖ removed bottom gap */
    height: 300px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Text letters */
  .letter-body {
    flex-grow: 1;
    overflow-y: auto;
  }

  /* Image letters */
  .letter-card img.clickable-image {
    width: 100%;
    max-height: 300px;
    border-radius: 14px;
    object-fit: contain;
  }

  /* PDF viewer */
  .pdf-card {
    border: none;
    padding: 0;
    background: transparent;
    box-shadow: none;
    margin: 0;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  .pdf-toolbar {
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-start;
    margin-bottom:6px;
  }
  .pdf-btn {
    border:1px solid #d4d4d8;
    background:#f3f4f6;
    padding:5px 9px;
    border-radius:999px;
    cursor:pointer;
    line-height:1;
    font-size:13px;
  }
  .pdf-btn:disabled {
    opacity:.35;
    cursor:not-allowed;
  }
  .pdf-badge {
    font-size:12px;
    color:#444;
    min-width:46px;
    text-align:center;
  }
  .pdf-canvas-wrap {
    width:100%;
    max-height:250px;
    overflow:auto;
    border-radius:12px;
    background:#fafafa;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }

  /* Like / Skip ‚Äì glued to card */
  .browse-actions {
    margin-top: 2px;
    margin-bottom: 0;
  }

  /* Even tighter on small phones */
  @media (max-height: 750px) {
    .letter-card {
      height: 230px;
    }
    .letter-card img.clickable-image {
      max-height: 210px;
    }
    .pdf-canvas-wrap {
      max-height: 185px;
    }
  }
</style>

{% if request.user.is_authenticated and request.user.profile.active_event %}
  <div class="t-card event-card">
    <form method="post" action="{% url 'toggle_event_mode' %}">
      {% csrf_token %}
      <div class="event-toggle-row">
        <label>
          <input
            type="checkbox"
            name="limit_to_event_pool"
            value="1"
            {% if request.user.profile.limit_to_event_pool %}checked{% endif %}
          >
          <span>Only show letters from the event:</span>
        </label>
        <strong>{{ request.user.profile.active_event.name }}</strong>
      </div>
      <div class="event-actions">
        <button type="submit" class="btn btn-primary">Update</button>
        <a href="{% url 'join_event' %}" class="btn btn-secondary">Change event</a>
      </div>
      <p class="event-note">hidden</p>
    </form>
  </div>
{% endif %}

<h2>Browse Letters üíå</h2>

{% if letter %}
  <div class="letter-card">

    {% if letter.letter_type == "text" %}
      <div class="letter-body">
        üìù {{ letter.text_content|linebreaksbr }}
      </div>

    {% elif letter.letter_type == "image" %}
      {% with group_id="browse" %}
      {% with images=letter.images.all %}
        {% for image in images %}
          <div style="display:{% if forloop.first %}block{% else %}none{% endif %};"
               class="slide-group-{{ group_id }}" id="slide-{{ group_id }}-{{ forloop.counter }}">
            <img src="{{ image.image.url }}" alt="Letter Image" class="clickable-image">
          </div>
        {% endfor %}

        {% if images|length > 1 %}
          <button onclick="prevSlide('{{ group_id }}', {{ images|length }})" id="prevBtn-{{ group_id }}"
                  style="position:absolute;left:0;top:45%;background:rgba(0,0,0,0.5);color:white;border:none;padding:6px;">&larr;</button>
          <button onclick="nextSlide('{{ group_id }}', {{ images|length }})" id="nextBtn-{{ group_id }}"
                  style="position:absolute;right:0;top:45%;background:rgba(0,0,0,0.5);color:white;border:none;padding:6px;">&rarr;</button>
        {% endif %}
      {% endwith %}
      {% endwith %}

    {% elif letter.letter_type == "pdf" and letter.pdf %}
      {% with gid="browse" %}
      <div class="pdf-card">
        <div class="pdf-toolbar">
          <button type="button" class="pdf-btn" id="prev-{{ gid }}">‚óÄ</button>
          <span class="pdf-badge" id="pageLabel-{{ gid }}">1 / 1</span>
          <button type="button" class="pdf-btn" id="next-{{ gid }}">‚ñ∂</button>
        </div>
        <div class="pdf-canvas-wrap">
          <canvas id="pdfCanvas-{{ gid }}"></canvas>
        </div>
      </div>

      <script>
        (function ensurePdfJs(){
          if (window.pdfjsLib) return;
          var s=document.createElement('script');
          s.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
          document.head.appendChild(s);
        })();
      </script>

      <script>
        (function initPDF{{ gid }}() {
          const url = "{{ letter.pdf.url }}";
          const canvas = document.getElementById('pdfCanvas-{{ gid }}');
          const ctx = canvas.getContext('2d');
          const prevBtn = document.getElementById('prev-{{ gid }}');
          const nextBtn = document.getElementById('next-{{ gid }}');

          let pdfDoc=null, pageNum=1;

          function renderPage(){
            pdfDoc.getPage(pageNum).then(page=>{
              const viewport = page.getViewport({ scale: 0.9 });
              canvas.height = viewport.height;
              canvas.width = viewport.width;
              page.render({canvasContext:ctx, viewport});
            });
          }

          pdfjsLib.getDocument(url).promise.then(doc=>{
            pdfDoc=doc;
            renderPage();
          });

          nextBtn.onclick = ()=>{ if(pageNum<pdfDoc.numPages){ pageNum++; renderPage(); }};
          prevBtn.onclick = ()=>{ if(pageNum>1){ pageNum--; renderPage(); }};
        })();
      </script>
      {% endwith %}
    {% endif %}
  </div>

  <form method="post" action="{% url 'react_to_letter' letter.id %}" class="browse-actions">
    {% csrf_token %}
    <button name="liked" value="true" class="btn btn-primary">‚ù§Ô∏è Like</button>
    <button name="liked" value="false" class="btn btn-primary" style="margin-left:10px;background:#2563eb;">‚ùå Skip</button>
  </form>

{% else %}
  <p>No more letters available.</p>
{% endif %}

<script src="{% static 'js/modal_image_viewer.js' %}"></script>
<script>
  const currentSlides = {};
  function showSlide(groupId,index,total){
    for(let i=1;i<=total;i++){
      const el=document.getElementById(`slide-${groupId}-${i}`);
      if(el) el.style.display=i===index?'block':'none';
    }
    currentSlides[groupId]=index;
  }
  function nextSlide(groupId,total){
    currentSlides[groupId]=(currentSlides[groupId]||1)+1;
    if(currentSlides[groupId]>total) currentSlides[groupId]=total;
    showSlide(groupId,currentSlides[groupId],total);
  }
  function prevSlide(groupId,total){
    currentSlides[groupId]=(currentSlides[groupId]||1)-1;
    if(currentSlides[groupId]<1) currentSlides[groupId]=1;
    showSlide(groupId,currentSlides[groupId],total);
  }
  document.addEventListener("DOMContentLoaded",()=>{
    const total=document.querySelectorAll(`.slide-group-browse`).length;
    if(total>0) showSlide("browse",1,total);
  });
</script>

{% endblock %}
