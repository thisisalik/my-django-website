{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
/* ========== PAGE LAYOUT ========== */

.container {
  min-height: auto;
  padding-bottom: 6px;
}


/* ========== EVENT BOX (SMALL, SECONDARY ‚Äì SAME AS BEFORE) ========== */

.t-card.event-card {
  background: rgba(255,255,255,0.7);
  border-radius: 12px;
  border: 1px dashed #d4d4d8;
  box-shadow: none;
  margin: 4px 0 6px;
  padding: 6px 10px;
  font-size: 0.8rem;
}

.event-card form { margin: 0; }

.event-toggle-row {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 2px;
}

.event-toggle-row label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
  margin: 0;
}

.event-toggle-row strong {
  margin-left: 2px;
  font-weight: 600;
}

.event-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 2px;
}

.event-note { display:none; }

.event-card .btn {
  padding: 4px 10px;
  font-size: 0.78rem;
}


/* ========== TITLE ========== */

h2 {
  margin: 6px 0 8px;
}


/* ========== LETTER CARD (5% SMALLER, IMAGE/TEXT/PDF FIT INSIDE) ========== */

.letter-card {
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:18px;
  box-shadow:0 8px 24px rgba(15,23,42,0.06);
  padding:12px 14px;
  margin:8px 0;

  /* no fixed min-height ‚Üí card hugs content, no extra white space */
  display: flex;
  flex-direction: column;
}

/* TEXT LETTER */
.letter-body {
  flex-grow: 1;
  max-height: 33vh;          /* was 39vh ‚Üí ~5% smaller */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-right: 6px;
}

/* IMAGE LETTER */
.letter-card img.clickable-image {
  width: 100%;
  max-height: 37vh;          /* was 45vh ‚Üí ~5% smaller */
  border-radius: 14px;
  object-fit: contain;
  display: block;
}

/* PDF LETTER */
.pdf-card {
  border: none;
  padding: 0;
  background: transparent;
  box-shadow: none;
  margin: 0;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}

.pdf-toolbar {
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-start;
  margin-bottom:6px;
}

.pdf-btn {
  border:1px solid #d4d4d8;
  background:#f3f4f6;
  padding:5px 9px;
  border-radius:999px;
  cursor:pointer;
  line-height:1;
  font-size:13px;
}

.pdf-btn:disabled { opacity:.35; }

.pdf-badge {
  font-size:12px;
  color:#444;
  min-width:46px;
  text-align:center;
}

.pdf-canvas-wrap {
  width:100%;
  max-height: 20vh;          /* fits inside card; ~5% smaller than before */
  overflow:auto;
  border-radius:12px;
  background:#fafafa;
  display:flex;
  justify-content:center;
  align-items:flex-start;
}


/* SHORT DEVICES */
@media (max-height: 750px) {
  .letter-body { max-height: 41vh; }
  .pdf-canvas-wrap,
  .letter-card img.clickable-image { max-height: 44vh; }
}


/* BUTTONS */
.browse-actions {
  margin-top: 6px;
}
</style>


{% if request.user.is_authenticated and request.user.profile.active_event %}
<div class="t-card event-card">
  <form method="post" action="{% url 'toggle_event_mode' %}">
    {% csrf_token %}

    <div class="event-toggle-row">
      <label>
        <input type="checkbox" name="limit_to_event_pool" value="1"
         {% if request.user.profile.limit_to_event_pool %}checked{% endif %}>
        Only show letters from:
      </label>
      <strong>{{ request.user.profile.active_event.name }}</strong>
    </div>

    <div class="event-actions">
      <button type="submit" class="btn btn-primary">Update</button>
      <a href="{% url 'join_event' %}" class="btn btn-secondary">Change event</a>
    </div>
  </form>
</div>
{% endif %}


<h2>Browse Letters üíå</h2>


{% if letter %}
<div class="letter-card">

  {% if letter.letter_type == "text" %}
    {% if letter.text_content %}
      <div class="letter-body">
        üìù {{ letter.text_content|linebreaksbr }}
      </div>
    {% else %}
      <em>No text available.</em>
    {% endif %}

  {% elif letter.letter_type == "image" %}
    <div style="position: relative;">
      {% with group_id="browse" %}
      {% with images=letter.images.all %}
        {% for image in images %}
          <div style="display: {% if forloop.first %}block{% else %}none{% endif %};"
               class="slide-group-{{ group_id }}" id="slide-{{ group_id }}-{{ forloop.counter }}">
            <img src="{{ image.image.url }}" alt="Letter Image" class="clickable-image">
          </div>
        {% endfor %}

        {% if images|length > 1 %}
          <button onclick="prevSlide('{{ group_id }}', {{ images|length }})" id="prevBtn-{{ group_id }}"
                  style="position:absolute;left:0;top:45%;transform:translateY(-50%);background:rgba(0,0,0,.5);color:white;border:none;padding:8px;">‚Üê</button>

          <button onclick="nextSlide('{{ group_id }}', {{ images|length }})" id="nextBtn-{{ group_id }}"
                  style="position:absolute;right:0;top:45%;transform:translateY(-50%);background:rgba(0,0,0,.5);color:white;border:none;padding:8px;">‚Üí</button>
        {% endif %}
      {% endwith %}
      {% endwith %}
    </div>

  {% elif letter.letter_type == "pdf" and letter.pdf %}
    {% with gid="browse" %}
    <div class="pdf-card" id="pdfCard-{{ gid }}">
      <div class="pdf-toolbar">
        <button type="button" class="pdf-btn" id="prev-{{ gid }}">‚óÄ</button>
        <span class="pdf-badge" id="pageLabel-{{ gid }}">1 / 1</span>
        <button type="button" class="pdf-btn" id="next-{{ gid }}">‚ñ∂</button>
        <span style="width:8px;"></span>
        <button type="button" class="pdf-btn" id="zoomOut-{{ gid }}">‚àí</button>
        <span class="pdf-badge" id="zoomLabel-{{ gid }}">100%</span>
        <button type="button" class="pdf-btn" id="zoomIn-{{ gid }}">Ôºã</button>
        <button type="button" class="pdf-btn" id="fit-{{ gid }}">Fit</button>
      </div>

      <div class="pdf-canvas-wrap">
        <canvas id="pdfCanvas-{{ gid }}"></canvas>
      </div>
    </div>

    <script>
      (function ensurePdfJs(){
        if(window.pdfjsLib) return;
        let s=document.createElement('script');
        s.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
        document.head.appendChild(s);
      })();
    </script>

    <script>
      (function initPDF(){
        const url="{{ letter.pdf.url }}";
        const gid="browse";
        const canvas=document.getElementById('pdfCanvas-'+gid);
        const ctx=canvas.getContext('2d');
        const prevBtn=document.getElementById('prev-'+gid);
        const nextBtn=document.getElementById('next-'+gid);
        const zoomIn=document.getElementById('zoomIn-'+gid);
        const zoomOut=document.getElementById('zoomOut-'+gid);
        const fitBtn=document.getElementById('fit-'+gid);
        const zoomLabel=document.getElementById('zoomLabel-'+gid);
        const pageLabel=document.getElementById('pageLabel-'+gid);
        const dpr=window.devicePixelRatio||1;

        let pdfDoc=null,pageNum=1,pageCount=1,scale=1,rendering=false;

        function update(){
          zoomLabel.textContent=Math.round(scale*100)+'%';
          pageLabel.textContent=pageNum+' / '+pageCount;
          prevBtn.disabled=pageNum<=1;
          nextBtn.disabled=pageNum>=pageCount;
        }

        function render(){
          if(rendering||!pdfDoc) return;
          rendering=true;
          pdfDoc.getPage(pageNum).then(p=>{
            let viewport=p.getViewport({ scale });
            canvas.style.width=viewport.width+'px';
            canvas.style.height=viewport.height+'px';
            canvas.width=viewport.width*dpr;
            canvas.height=viewport.height*dpr;
            p.render({ canvasContext:ctx, viewport, transform:dpr!==1?[dpr,0,0,dpr,0,0]:null })
             .promise.finally(()=>{ rendering=false;update(); });
          });
        }

        function load(){
          pdfjsLib.getDocument(url).promise.then(p=>{
            pdfDoc=p;pageCount=p.numPages;render();
          });
        }

        function setWorker(){
          pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
        }

        if(window.pdfjsLib){ setWorker(); load(); }
        else{
          let i=setInterval(()=>{
            if(window.pdfjsLib){ clearInterval(i); setWorker(); load(); }
          },40);
        }

        zoomIn.onclick=()=>{ scale+=.15;render(); };
        zoomOut.onclick=()=>{ scale=Math.max(.5,scale-.15);render(); };
        fitBtn.onclick=()=>{ render(); };
        prevBtn.onclick=()=>{ if(pageNum>1){ pageNum--;render(); }};
        nextBtn.onclick=()=>{ if(pageNum<pageCount){ pageNum++;render(); }};
      })();
    </script>
    {% endwith %}
  {% endif %}

</div>


<form method="post" action="{% url 'react_to_letter' letter.id %}" class="browse-actions">
  {% csrf_token %}
  <button name="liked" value="true" class="btn btn-primary">‚ù§Ô∏è Like</button>
  <button name="liked" value="false" class="btn btn-primary" style="margin-left: 10px; background:#2563eb;">‚ùå Skip</button>
</form>

{% else %}
  <p>No more letters available. Try again later.</p>
{% endif %}


<script src="{% static 'js/modal_image_viewer.js' %}"></script>

<script>
  const currentSlides = {};

  function showSlide(groupId, index, total) {
    for (let i = 1; i <= total; i++) {
      const slide = document.getElementById(`slide-${groupId}-${i}`);
      if (slide) {
        slide.style.display = (i === index) ? 'block' : 'none';
      }
    }

    const prevBtn = document.getElementById(`prevBtn-${groupId}`);
    const nextBtn = document.getElementById(`nextBtn-${groupId}`);

    if (prevBtn) prevBtn.style.display = index === 1 ? 'none' : 'block';
    if (nextBtn) nextBtn.style.display = index === total ? 'none' : 'block';

    currentSlides[groupId] = index;
  }

  function nextSlide(groupId, total) {
    if (!currentSlides[groupId]) currentSlides[groupId] = 1;
    if (currentSlides[groupId] < total) {
      currentSlides[groupId]++;
      showSlide(groupId, currentSlides[groupId], total);
    }
  }

  function prevSlide(groupId, total) {
    if (!currentSlides[groupId]) currentSlides[groupId] = 1;
    if (currentSlides[groupId] > 1) {
      currentSlides[groupId]--;
      showSlide(groupId, currentSlides[groupId], total);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const groupId = "browse";
    const total = document.querySelectorAll(`.slide-group-${groupId}`).length;
    if (total > 0) {
      showSlide(groupId, 1, total);
    }
  });
</script>

{% endblock %}
