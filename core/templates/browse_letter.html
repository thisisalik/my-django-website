{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
  /* --- Event filter card --- */
  .event-card {
    margin-bottom: 14px;
  }

  .event-filter-form {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
  }

  .event-filter-main {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .event-filter-main input[type="checkbox"] {
    transform: scale(1.05);
  }

  .event-filter-actions {
    margin-left: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  @media (max-width: 560px) {
    .event-filter-form {
      flex-direction: column;
      align-items: flex-start;
    }
    .event-filter-actions {
      margin-left: 0;
    }
  }

  .event-note {
    font-size: 0.9rem;
    color: #4b5563;
    margin-top: 4px;
  }

  /* Letter card spacing on this page */
  .letter-card-browse {
    margin-top: 10px;
  }

  /* Like / skip row */
  .like-skip-row {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 18px;
    flex-wrap: wrap;
  }
  .like-skip-row .btn {
    min-width: 130px;
  }

  /* Make PDF height similar to images */
  .pdf-canvas-wrap {
    max-height: 400px;
  }
  @media (max-width: 600px) {
    .pdf-canvas-wrap {
      max-height: 360px;
    }
  }
</style>

{% if request.user.is_authenticated and request.user.profile.active_event %}
  <div class="t-card event-card">
    <form method="post"
          action="{% url 'toggle_event_mode' %}"
          class="event-filter-form">
      {% csrf_token %}

      <div class="event-filter-main">
        <label style="display:flex;align-items:center;gap:6px;">
          <input
            type="checkbox"
            name="limit_to_event_pool"
            value="1"
            {% if request.user.profile.limit_to_event_pool %}checked{% endif %}
          >
          <span>Only show letters from the event:</span>
        </label>
        <strong>{{ request.user.profile.active_event.name }}</strong>
      </div>

      <div class="event-filter-actions">
        <button type="submit" class="btn btn-secondary">
          Update
        </button>
        <a href="{% url 'join_event' %}" class="btn btn-secondary">
          Change event
        </a>
      </div>

      <div class="event-note">
        You can switch the event anytime ‚Äî this only affects which letters you see.
      </div>
    </form>
  </div>
{% endif %}

<h2>Browse Letters üíå</h2>

{% if letter %}
  <div class="t-card letter-card-browse">
    {# TEXT LETTER #}
    {% if letter.letter_type == "text" %}
      {% if letter.text_content %}
        <div class="letter-card">
          <div class="letter-body">
            üìù {{ letter.text_content|linebreaksbr }}
          </div>
        </div>
      {% else %}
        <div class="letter-card"><em>No text available.</em></div>
      {% endif %}

    {# IMAGE LETTER #}
    {% elif letter.letter_type == "image" %}
      <div class="letter-card">
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
          <div style="position: relative; max-width: 400px; margin-top: 10px;">
            {% with group_id="browse" %}
              {% with images=letter.images.all %}
                {% for image in images %}
                  <div style="display: {% if forloop.first %}block{% else %}none{% endif %};"
                       class="slide-group-{{ group_id }}" id="slide-{{ group_id }}-{{ forloop.counter }}">
                    <img src="{{ image.image.url }}" alt="Letter Image"
                         class="clickable-image"
                         style="width: 100%; border-radius: 8px; max-height: 400px; object-fit: contain;">
                  </div>
                {% endfor %}

                {% if images|length > 1 %}
                  <button onclick="prevSlide('{{ group_id }}', {{ images|length }})" id="prevBtn-{{ group_id }}"
                          style="position: absolute; left: 0; top: 45%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px;">&larr;</button>
                  <button onclick="nextSlide('{{ group_id }}', {{ images|length }})" id="nextBtn-{{ group_id }}"
                          style="position: absolute; right: 0; top: 45%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px;">&rarr;</button>
                {% endif %}
              {% endwith %}
            {% endwith %}
          </div>
        </div>
      </div>

    {# PDF LETTER #}
    {% elif letter.letter_type == "pdf" and letter.pdf %}
      <div class="letter-card">
        {% with gid="browse" %}
          <style>
            .pdf-card { border:1px solid #ddd;border-radius:12px;padding:12px; }
            .pdf-toolbar {
              display:flex;align-items:center;gap:8px;flex-wrap:wrap;
              justify-content:flex-start;margin-bottom:10px;
            }
            .pdf-btn {
              border:1px solid #ccc;background:#f6f6f6;
              padding:6px 10px;border-radius:8px;cursor:pointer;
              line-height:1;font-size:14px;
            }
            .pdf-btn:disabled { opacity:.4;cursor:not-allowed; }
            .pdf-badge { font-size:13px;color:#444;min-width:56px;text-align:center; }
            .pdf-canvas-wrap {
              width:100%;
              overflow:auto;
              border-radius:8px;
              background:#fafafa;
              display:flex;
              justify-content:center;
              align-items:flex-start;
            }
            .pdf-canvas-wrap::-webkit-scrollbar { height:8px;width:8px; }
            .pdf-canvas-wrap::-webkit-scrollbar-thumb { background:#d0d0d0;border-radius:8px; }
            @media (max-width:420px){
              .pdf-card{padding:8px;border-radius:10px}
              .pdf-toolbar{gap:6px;margin-bottom:6px}
              .pdf-btn{padding:5px 8px;border-radius:7px;font-size:13px}
              .pdf-badge{font-size:12px;min-width:48px}
            }
          </style>

          <div class="pdf-card" id="pdfCard-{{ gid }}">
            <div class="pdf-toolbar">
              <button type="button" class="pdf-btn" id="prev-{{ gid }}">‚óÄ</button>
              <span class="pdf-badge" id="pageLabel-{{ gid }}">1 / 1</span>
              <button type="button" class="pdf-btn" id="next-{{ gid }}">‚ñ∂</button>

              <span style="width:12px;"></span>

              <button type="button" class="pdf-btn" id="zoomOut-{{ gid }}">‚àí</button>
              <span class="pdf-badge" id="zoomLabel-{{ gid }}">100%</span>
              <button type="button" class="pdf-btn" id="zoomIn-{{ gid }}">Ôºã</button>
              <button type="button" class="pdf-btn" id="fit-{{ gid }}">Fit</button>
            </div>

            <div class="pdf-canvas-wrap">
              <canvas id="pdfCanvas-{{ gid }}"></canvas>
            </div>
          </div>

          {# Load pdf.js once if not present #}
          <script>
            (function ensurePdfJs(){
              if (window.pdfjsLib) return;
              var s=document.createElement('script');
              s.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
              document.head.appendChild(s);
            })();
          </script>

          <script>
            (function initPDF{{ gid }}() {
              const url        = "{{ letter.pdf.url }}";
              const canvas     = document.getElementById('pdfCanvas-{{ gid }}');
              const ctx        = canvas.getContext('2d');
              const prevBtn    = document.getElementById('prev-{{ gid }}');
              const nextBtn    = document.getElementById('next-{{ gid }}');
              const zoomInBtn  = document.getElementById('zoomIn-{{ gid }}');
              const zoomOutBtn = document.getElementById('zoomOut-{{ gid }}');
              const fitBtn     = document.getElementById('fit-{{ gid }}');
              const zoomLabel  = document.getElementById('zoomLabel-{{ gid }}');
              const pageLabel  = document.getElementById('pageLabel-{{ gid }}');
              const dpr        = window.devicePixelRatio || 1;

              let pdfDoc=null, pageNum=1, pageCount=1, baseScale=1, scale=1, rendering=false;

              function updateLabels(){
                zoomLabel.textContent = Math.round(scale*100) + '%';
                pageLabel.textContent = pageNum + ' / ' + pageCount;
                prevBtn.disabled = (pageNum<=1);
                nextBtn.disabled = (pageNum>=pageCount);
              }

              function fitToWidth(page){
                const card = document.getElementById('pdfCard-{{ gid }}');
                const wrap = card.querySelector('.pdf-canvas-wrap');
                const available = wrap.clientWidth - 2;
                const viewport1 = page.getViewport({ scale:1 });
                baseScale = available / viewport1.width;
                scale = baseScale;
              }

              function renderPage(){
                if (rendering) return;
                rendering = true;
                pdfDoc.getPage(pageNum).then(page=>{
                  if (baseScale===1) fitToWidth(page);
                  const viewport = page.getViewport({ scale });
                  canvas.style.width = Math.round(viewport.width)+'px';
                  canvas.style.height = Math.round(viewport.height)+'px';
                  canvas.width = Math.round(viewport.width*dpr);
                  canvas.height = Math.round(viewport.height*dpr);
                  const transform = dpr!==1 ? [dpr,0,0,dpr,0,0] : null;
                  page.render({ canvasContext: ctx, viewport, transform }).promise.finally(()=>{
                    rendering=false; updateLabels();
                  });
                });
              }

              function start(){
                pdfjsLib.getDocument(url).promise.then(doc=>{
                  pdfDoc = doc; pageCount = doc.numPages; pageNum = 1;
                  renderPage();
                  const card = document.getElementById('pdfCard-{{ gid }}');
                  if ('ResizeObserver' in window){
                    const ro = new ResizeObserver(()=>{ baseScale=1; renderPage(); });
                    ro.observe(card);
                  } else {
                    window.addEventListener('resize', ()=>{ baseScale=1; renderPage(); });
                  }
                }).catch(console.error);
              }

              function setWorker(){
                pdfjsLib.GlobalWorkerOptions.workerSrc =
                  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
              }

              if (window.pdfjsLib){ setWorker(); start(); }
              else {
                const iv = setInterval(()=>{
                  if (window.pdfjsLib){ clearInterval(iv); setWorker(); start(); }
                }, 40);
              }

              // controls
              zoomInBtn.addEventListener('click', ()=>{ scale=Math.min(scale+0.15,4); renderPage(); });
              zoomOutBtn.addEventListener('click', ()=>{ scale=Math.max(scale-0.15,0.4); renderPage(); });
              fitBtn.addEventListener('click', ()=>{ baseScale=1; renderPage(); });
              prevBtn.addEventListener('click', ()=>{ if(pageNum>1){ pageNum--; renderPage(); } });
              nextBtn.addEventListener('click', ()=>{ if(pageNum<pageCount){ pageNum++; renderPage(); } });
            })();
          </script>
        {% endwith %}
      </div>
    {% endif %}
  </div>

  <form method="post" action="{% url 'react_to_letter' letter.id %}" style="margin-top: 4px;">
    {% csrf_token %}
    <div class="like-skip-row">
      <button name="liked" value="true" class="btn btn-primary">‚ù§Ô∏è Like</button>
      <button name="liked" value="false" class="btn btn-primary">‚ùå Skip</button>
    </div>
  </form>
{% else %}
  <p>No more letters available. Try again later.</p>
{% endif %}

<script src="{% static 'js/modal_image_viewer.js' %}"></script>
<script>
  const currentSlides = {};

  function showSlide(groupId, index, total) {
    for (let i = 1; i <= total; i++) {
      const slide = document.getElementById(`slide-${groupId}-${i}`);
      if (slide) {
        slide.style.display = (i === index) ? 'block' : 'none';
      }
    }

    const prevBtn = document.getElementById(`prevBtn-${groupId}`);
    const nextBtn = document.getElementById(`nextBtn-${groupId}`);

    if (prevBtn) prevBtn.style.display = index === 1 ? 'none' : 'block';
    if (nextBtn) nextBtn.style.display = index === total ? 'none' : 'block';

    currentSlides[groupId] = index;
  }

  function nextSlide(groupId, total) {
    if (!currentSlides[groupId]) currentSlides[groupId] = 1;
    if (currentSlides[groupId] < total) {
      currentSlides[groupId]++;
      showSlide(groupId, currentSlides[groupId], total);
    }
  }

  function prevSlide(groupId, total) {
    if (!currentSlides[groupId]) currentSlides[groupId] = 1;
    if (currentSlides[groupId] > 1) {
      currentSlides[groupId]--;
      showSlide(groupId, currentSlides[groupId], total);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const groupId = "browse";
    const total = document.querySelectorAll(`.slide-group-${groupId}`).length;
    if (total > 0) {
      showSlide(groupId, 1, total);
    }
  });
</script>

{% endblock %}
