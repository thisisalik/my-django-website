{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
  /* --- Event card: more compact --- */
  .event-card {
    margin-bottom: 10px;
    padding: 10px 14px;
    border-radius: 16px;
    background: #ffffff;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
    border: 1px solid #e5e7eb;
    font-size: 0.9rem;
  }
  .event-card-title {
    font-weight: 600;
    margin: 0 0 4px;
  }
  .event-card p {
    margin: 4px 0 0;
    color: #4b5563;
    line-height: 1.35;
  }
  .event-actions {
    margin-top: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  .event-pill {
    border-radius: 999px;
    padding: 7px 14px;
    border: none;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .event-pill-primary {
    background:#111827;
    color:#fff;
  }
  .event-pill-secondary {
    background:#e5e7eb;
    color:#111827;
  }

  /* --- Browse card heading --- */
  h2 {
    margin: 10px 0 10px;
  }

  /* --- Letter cards (we keep your existing .letter-card look, just tweak height) --- */
  .letter-card {
    /* you already have base styles in base_style.css, this only tweaks spacing */
    margin: 8px 0 10px;
  }

  /* === PDF viewer tweaks so it feels like the image version === */

  /* Only affect PDF version by extra class */
  .letter-card--pdf {
    padding-top: 12px;
    padding-bottom: 12px;
  }

  .pdf-toolbar {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:6px;
    margin-bottom:6px;
    font-size:0.88rem;
  }
  .pdf-toolbar-left,
  .pdf-toolbar-right {
    display:flex;
    align-items:center;
    gap:6px;
  }

  .pdf-btn {
    border:1px solid #d1d5db;
    background:#f9fafb;
    padding:4px 8px;
    border-radius:999px;
    cursor:pointer;
    font-size:0.8rem;
    line-height:1;
  }
  .pdf-btn:disabled {
    opacity:.35;
    cursor:not-allowed;
  }
  .pdf-badge {
    font-size:0.8rem;
    color:#4b5563;
    min-width:44px;
    text-align:center;
  }

  /* The important part: similar visual height to image letters */
  .pdf-canvas-wrap {
    width:100%;
    max-height: 260px;      /* ‚Üì shorter than before */
    overflow:auto;
    border-radius:12px;
    background:#fafafa;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }

  .pdf-canvas-wrap::-webkit-scrollbar { height:6px; width:6px; }
  .pdf-canvas-wrap::-webkit-scrollbar-thumb {
    background:#d4d4d8;
    border-radius:999px;
  }

  @media (max-width: 480px) {
    .event-card { padding: 9px 12px; }
    .event-pill { padding: 6px 12px; }
    .pdf-canvas-wrap { max-height: 230px; }  /* a bit tighter on small phones */
  }

  /* --- Logout button spacing: pull it closer to Like/Skip --- */
  .logout-row {
    margin-top: 10px;   /* was larger before */
    display:flex;
    justify-content:center;
  }
</style>


{# -------- EVENT CARD (more compact) -------- #}
{% if request.user.is_authenticated and request.user.profile.active_event %}
  <div class="event-card">
    <div class="event-card-title">
      <label style="display:flex;align-items:center;gap:8px;margin:0;">
        <input
          type="checkbox"
          name="dummy" disabled
          {% if request.user.profile.limit_to_event_pool %}checked{% endif %}
          style="width:18px;height:18px;"
        >
        <span>Only show letters from the event:</span>
      </label>
      <div style="margin-top:2px;font-size:1rem;">
        <strong>{{ request.user.profile.active_event.name }}</strong>
      </div>
    </div>

    <form method="post" action="{% url 'toggle_event_mode' %}" style="margin:6px 0 0;">
      {% csrf_token %}
      <input type="hidden" name="limit_to_event_pool" value="1">
      <div class="event-actions">
        <button type="submit" class="event-pill event-pill-primary">Update</button>
        <a href="{% url 'join_event' %}" class="event-pill event-pill-secondary" style="text-decoration:none;">
          Change event
        </a>
      </div>
    </form>

    <p>
      You can switch the event anytime ‚Äî this only changes which letters you see.
    </p>
  </div>
{% endif %}



<h2>Browse Letters üíå</h2>

{% if letter %}

  {# ---------- TEXT LETTER ---------- #}
  {% if letter.letter_type == "text" %}
    {% if letter.text_content %}
      <div class="letter-card">
        <div class="letter-body">
          üìù {{ letter.text_content|linebreaksbr }}
        </div>
      </div>
    {% else %}
      <div class="letter-card"><em>No text available.</em></div>
    {% endif %}

  {# ---------- IMAGE LETTER ---------- #}
  {% elif letter.letter_type == "image" %}
    <div class="letter-card">
      <div style="display:flex;flex-wrap:wrap;gap:10px;">
        <div style="position:relative; width:100%; max-width:400px; margin:0 auto;">
          {% with group_id="browse" %}
            {% with images=letter.images.all %}
              {% for image in images %}
                <div style="display:{% if forloop.first %}block{% else %}none{% endif %};"
                     class="slide-group-{{ group_id }}"
                     id="slide-{{ group_id }}-{{ forloop.counter }}">
                  <img src="{{ image.image.url }}" alt="Letter Image"
                       class="clickable-image"
                       style="width:100%;border-radius:8px;max-height:400px;object-fit:contain;">
                </div>
              {% endfor %}

              {% if images|length > 1 %}
                <button type="button" onclick="prevSlide('{{ group_id }}', {{ images|length }})"
                        id="prevBtn-{{ group_id }}"
                        style="position:absolute;left:0;top:45%;transform:translateY(-50%);
                               background:rgba(0,0,0,0.5);color:#fff;border:none;padding:8px;border-radius:999px;">
                  &larr;
                </button>
                <button type="button" onclick="nextSlide('{{ group_id }}', {{ images|length }})"
                        id="nextBtn-{{ group_id }}"
                        style="position:absolute;right:0;top:45%;transform:translateY(-50%);
                               background:rgba(0,0,0,0.5);color:#fff;border:none;padding:8px;border-radius:999px;">
                  &rarr;
                </button>
              {% endif %}
            {% endwith %}
          {% endwith %}
        </div>
      </div>
    </div>

  {# ---------- PDF LETTER ---------- #}
  {% elif letter.letter_type == "pdf" and letter.pdf %}
    {% with gid="browse" %}
      <div class="letter-card letter-card--pdf" id="pdfCard-{{ gid }}">
        <div class="pdf-toolbar">
          <div class="pdf-toolbar-left">
            <button type="button" class="pdf-btn" id="prev-{{ gid }}">‚óÄ</button>
            <span class="pdf-badge" id="pageLabel-{{ gid }}">1 / 1</span>
            <button type="button" class="pdf-btn" id="next-{{ gid }}">‚ñ∂</button>
          </div>
          <div class="pdf-toolbar-right">
            <button type="button" class="pdf-btn" id="zoomOut-{{ gid }}">‚àí</button>
            <span class="pdf-badge" id="zoomLabel-{{ gid }}">100%</span>
            <button type="button" class="pdf-btn" id="zoomIn-{{ gid }}">Ôºã</button>
            <button type="button" class="pdf-btn" id="fit-{{ gid }}">Fit</button>
          </div>
        </div>

        <div class="pdf-canvas-wrap">
          <canvas id="pdfCanvas-{{ gid }}"></canvas>
        </div>
      </div>

      {# Load pdf.js once if not present #}
      <script>
        (function ensurePdfJs(){
          if (window.pdfjsLib) return;
          var s=document.createElement('script');
          s.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
          document.head.appendChild(s);
        })();
      </script>

      <script>
        (function initPDF{{ gid }}() {
          const url        = "{{ letter.pdf.url }}";
          const canvas     = document.getElementById('pdfCanvas-{{ gid }}');
          const ctx        = canvas.getContext('2d');
          const prevBtn    = document.getElementById('prev-{{ gid }}');
          const nextBtn    = document.getElementById('next-{{ gid }}');
          const zoomInBtn  = document.getElementById('zoomIn-{{ gid }}');
          const zoomOutBtn = document.getElementById('zoomOut-{{ gid }}');
          const fitBtn     = document.getElementById('fit-{{ gid }}');
          const zoomLabel  = document.getElementById('zoomLabel-{{ gid }}');
          const pageLabel  = document.getElementById('pageLabel-{{ gid }}');
          const dpr        = window.devicePixelRatio || 1;

          let pdfDoc=null, pageNum=1, pageCount=1, baseScale=1, scale=1, rendering=false;

          function updateLabels(){
            zoomLabel.textContent = Math.round(scale*100) + '%';
            pageLabel.textContent = pageNum + ' / ' + pageCount;
            prevBtn.disabled = (pageNum<=1);
            nextBtn.disabled = (pageNum>=pageCount);
          }

          function fitToWidth(page){
            const card = document.getElementById('pdfCard-{{ gid }}');
            const wrap = card.querySelector('.pdf-canvas-wrap');
            const available = wrap.clientWidth - 2;
            const viewport1 = page.getViewport({ scale:1 });
            baseScale = available / viewport1.width;
            scale = baseScale;
          }

          function renderPage(){
            if (rendering) return;
            rendering = true;
            pdfDoc.getPage(pageNum).then(page=>{
              if (baseScale===1) fitToWidth(page);
              const viewport = page.getViewport({ scale });
              canvas.style.width = Math.round(viewport.width)+'px';
              canvas.style.height = Math.round(viewport.height)+'px';
              canvas.width = Math.round(viewport.width*dpr);
              canvas.height = Math.round(viewport.height*dpr);
              const transform = dpr!==1 ? [dpr,0,0,dpr,0,0] : null;
              page.render({ canvasContext: ctx, viewport, transform }).promise.finally(()=>{
                rendering=false; updateLabels();
              });
            });
          }

          function start(){
            pdfjsLib.getDocument(url).promise.then(doc=>{
              pdfDoc = doc; pageCount = doc.numPages; pageNum = 1;
              renderPage();
              const card = document.getElementById('pdfCard-{{ gid }}');
              if ('ResizeObserver' in window){
                const ro = new ResizeObserver(()=>{ baseScale=1; renderPage(); });
                ro.observe(card);
              } else {
                window.addEventListener('resize', ()=>{ baseScale=1; renderPage(); });
              }
            }).catch(console.error);
          }

          function setWorker(){
            pdfjsLib.GlobalWorkerOptions.workerSrc =
              "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
          }

          if (window.pdfjsLib){ setWorker(); start(); }
          else {
            const iv = setInterval(()=>{
              if (window.pdfjsLib){ clearInterval(iv); setWorker(); start(); }
            }, 40);
          }

          zoomInBtn.addEventListener('click', ()=>{ scale=Math.min(scale+0.15,4); renderPage(); });
          zoomOutBtn.addEventListener('click', ()=>{ scale=Math.max(scale-0.15,0.4); renderPage(); });
          fitBtn.addEventListener('click', ()=>{ baseScale=1; renderPage(); });
          prevBtn.addEventListener('click', ()=>{ if(pageNum>1){ pageNum--; renderPage(); } });
          nextBtn.addEventListener('click', ()=>{ if(pageNum<pageCount){ pageNum++; renderPage(); } });
        })();
      </script>
    {% endwith %}
  {% endif %}

  {# ---------- LIKE / SKIP ---------- #}
  <form method="post" action="{% url 'react_to_letter' letter.id %}" style="margin-top: 14px; text-align:center;">
    {% csrf_token %}
    <button name="liked" value="true" class="btn">‚ù§Ô∏è Like</button>
    <button name="liked" value="false" class="btn" style="margin-left: 10px;">‚ùå Skip</button>
  </form>

{% else %}
  <p>No more letters available. Try again later.</p>
{% endif %}

<div class="logout-row">
  <form action="/accounts/logout/" method="post" style="margin:0;">
    {% csrf_token %}
    <button type="submit"
            style="border:none;border-radius:999px;padding:8px 18px;background:#e5e7eb;
                   font-weight:600;cursor:pointer;">
      Logout
    </button>
  </form>
</div>

<script src="{% static 'js/modal_image_viewer.js' %}"></script>
<script>
  const currentSlides = {};
  function showSlide(groupId, index, total) {
    for (let i = 1; i <= total; i++) {
      const slide = document.getElementById(`slide-${groupId}-${i}`);
      if (slide) slide.style.display = (i === index) ? 'block' : 'none';
    }
    const prevBtn = document.getElementById(`prevBtn-${groupId}`);
    const nextBtn = document.getElementById(`nextBtn-${groupId}`);
    if (prevBtn) prevBtn.style.display = index === 1 ? 'none' : 'block';
    if (nextBtn) nextBtn.style.display = index === total ? 'none' : 'block';
    currentSlides[groupId] = index;
  }
  function nextSlide(groupId, total) {
    if (!currentSlides[groupId]) currentSlides[groupId] = 1;
    if (currentSlides[groupId] < total) {
      currentSlides[groupId]++;
      showSlide(groupId, currentSlides[groupId], total);
    }
  }
  function prevSlide(groupId, total) {
    if (!currentSlides[groupId]) currentSlides[groupId] = 1;
    if (currentSlides[groupId] > 1) {
      currentSlides[groupId]--;
      showSlide(groupId, currentSlides[groupId], total);
    }
  }
  document.addEventListener("DOMContentLoaded", () => {
    const groupId = "browse";
    const total = document.querySelectorAll(`.slide-group-${groupId}`).length;
    if (total > 0) showSlide(groupId, 1, total);
  });
</script>

{% endblock %}
