{% extends 'base.html' %}
{% load tz %}
{% block content %}
<style>
    .chat-box {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 10px;
      height: 400px;
      overflow-y: auto;
      background-color: #fff;
    }
  
    .message-row {
      display: flex;
      margin-bottom: 10px;
      max-width: 100%;
    }
  
    .message-bubble {
      padding: 10px 15px;
      border-radius: 18px;
      max-width: 70%;
      word-wrap: break-word;
    }
  
    .from-me {
      justify-content: flex-end;
    }
  
    .from-me .message-bubble {
      background-color: #dcf8c6;
      align-self: flex-end;
    }
  
    .from-them {
      justify-content: flex-start;
    }
  
    .from-them .message-bubble {
      background-color: #f1f0f0;
      align-self: flex-start;
    }
  
    .timestamp {
      font-size: 0.75rem;
      color: #777;
      margin-top: 2px;
      margin-left: 5px;
    }
  </style>
  

<div class="chat-container">
  <h2>Chat with {{ receiver.name }}</h2>

  <div class="chat-box" id="message-container">
    {% for message in messages %}
      <div class="message-row {% if message.sender == request.user.profile %}from-me{% else %}from-them{% endif %}">
        <div class="message-bubble">
          {{ message.text }}
          <div class="timestamp">{{ message.timestamp|date:"M j, Y, g:i a" }}</div>
        </div>
      </div>
    {% empty %}
      <p>No messages yet.</p>
    {% endfor %}
  </div>

  <form method="post" id="message-form" class="chat-form">
    {% csrf_token %}
    {{ form.text.label_tag }}<br>
    {{ form.text }}<br>
    <button type="submit">Send</button>
  </form>

  <p><a href="/chats/">← Back to Chat List</a></p>
</div>

<script>
    function localizeTimestamps() {
      document.querySelectorAll('.timestamp').forEach(function (el) {
        var iso = el.getAttribute('data-ts');
        if (!iso) return;
        var d = new Date(iso);          // parses UTC ISO like "2025-09-09T16:55:00Z"
        if (isNaN(d)) return;
        el.textContent = d.toLocaleString(undefined, {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit'
        });
      });
    }
  
    function loadMessages() {
      fetch("{% url 'fetch_messages' receiver.id %}")
        .then(response => response.text())
        .then(html => {
          document.getElementById("message-container").innerHTML = html;
          localizeTimestamps(); // ← convert after replacing HTML
          const box = document.getElementById("message-container");
          box.scrollTop = box.scrollHeight;
        });
    }
  
    // initial load + polling
    document.addEventListener('DOMContentLoaded', function () {
      localizeTimestamps(); // in case the page had initial messages
      loadMessages();
      setInterval(loadMessages, 5000);
    });
  </script>
  
{% endblock %}
