{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  .likes-header {
    font-size: 1.2rem;
    margin-bottom: 12px;
  }

  .like-card {
    background: white;
    border-radius: 14px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 2px 8px rgba(15,23,42,.05);
    padding: 12px;
    margin-bottom: 16px;
  }

  .letter-title {
    font-weight: 600;
    margin-bottom: 6px;
  }

  .actions-row {
    display: flex;
    gap: 10px;
    margin-top: 14px;
  }

  .like-btn {
    flex: 1;
    border-radius: 999px;
    padding: 10px 14px;
    border: none;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-like {
    background: #3b82f6;
    color: white;
  }

  .btn-like:hover { background: #2563eb; }

  .btn-skip {
    background: #6b7280;
    color: white;
  }

  .btn-skip:hover { background: #4b5563; }

  .empty-state {
    text-align: center;
    padding: 30px 10px;
    color: #555;
  }
</style>

<h2 class="likes-header">Likes You üê¢</h2>

{% if likes %}
  {% for like in likes %}
    {% with letter=like.from_profile.letter_set.last %}
      <div class="like-card">

        <div class="letter-title">Letter üíå</div>

        {# ---------- TEXT ---------- #}
        {% if letter.letter_type == "text" %}
          {% if letter.text_content %}
            <div class="letter-card">
              <div class="letter-body">
                üìù {{ letter.text_content|linebreaksbr }}
              </div>
            </div>
          {% else %}
            <div class="letter-card"><em>No text available.</em></div>
          {% endif %}

        {# ---------- IMAGE ---------- #}
        {% elif letter.letter_type == "image" %}
          <div style="position: relative; max-width: 420px; margin-top: 6px;">
            {% with group_id="like"|add:forloop.counter|stringformat:"s" %}
              {% with images=letter.images.all %}
                {% for image in images %}
                  <div style="display: {% if forloop.first %}block{% else %}none{% endif %};"
                       class="slide-group-{{ group_id }}" id="slide-{{ group_id }}-{{ forloop.counter }}">
                    <img src="{{ image.image.url }}"
                         class="clickable-image"
                         style="
                           width:100%;
                           border-radius:12px;
                           max-height:420px;
                           object-fit:contain;
                           box-shadow:0 3px 10px rgba(0,0,0,.06);" />
                  </div>
                {% endfor %}

                {% if images|length > 1 %}
                  <button onclick="prevSlide('{{ group_id }}', {{ images|length }})"
                          id="prevBtn-{{ group_id }}"
                          style="position:absolute;left:6px;top:45%;
                                 transform:translateY(-50%);
                                 background:rgba(0,0,0,.5);
                                 color:white;border:none;
                                 padding:8px;border-radius:50%;">‚Äπ</button>

                  <button onclick="nextSlide('{{ group_id }}', {{ images|length }})"
                          id="nextBtn-{{ group_id }}"
                          style="position:absolute;right:6px;top:45%;
                                 transform:translateY(-50%);
                                 background:rgba(0,0,0,.5);
                                 color:white;border:none;
                                 padding:8px;border-radius:50%;">‚Ä∫</button>
                {% endif %}
              {% endwith %}
            {% endwith %}
          </div>

        {# ---------- PDF ---------- #}
        {% elif letter.letter_type == "pdf" and letter.pdf %}
          {% with gid=forloop.counter0 %}

            <!-- PDF styles unchanged -->
            ... (PDF VIEWER CODE UNCHANGED ‚Äì KEEP YOUR ORIGINAL BLOCK HERE)

          {% endwith %}
        {% endif %}

        <div class="actions-row">
          <form method="post" action="{% url 'like_back' like.from_profile.id %}">
            {% csrf_token %}
            <button type="submit" class="like-btn btn-like">‚ù§Ô∏è Like Back</button>
          </form>

          <form method="post" action="{% url 'reject_like' like.from_profile.id %}">
            {% csrf_token %}
            <button type="submit" class="like-btn btn-skip">‚ùå Skip</button>
          </form>
        </div>

      </div>
    {% endwith %}
  {% endfor %}
{% else %}
  <div class="empty-state">
    <p>No one has liked you yet.</p>
    <p>Be patient üê¢</p>
  </div>
{% endif %}

<script src="{% static 'js/modal_image_viewer.js' %}"></script>

<script>
  const currentSlides = {};
  function showSlide(groupId, index, total) {
    for (let i = 1; i <= total; i++) {
      const slide = document.getElementById(`slide-${groupId}-${i}`);
      if (slide) slide.style.display = (i === index) ? "block" : "none";
    }
    const prevBtn = document.getElementById(`prevBtn-${groupId}`);
    const nextBtn = document.getElementById(`nextBtn-${groupId}`);
    if (prevBtn) prevBtn.style.display = index === 1 ? "none" : "block";
    if (nextBtn) nextBtn.style.display = index === total ? "none" : "block";
    currentSlides[groupId] = index;
  }

  function nextSlide(groupId, total) {
    if (!currentSlides[groupId]) currentSlides[groupId] = 1;
    if (currentSlides[groupId] < total) {
      currentSlides[groupId]++;
      showSlide(groupId, currentSlides[groupId], total);
    }
  }

  function prevSlide(groupId, total) {
    if (!currentSlides[groupId]) currentSlides[groupId] = 1;
    if (currentSlides[groupId] > 1) {
      currentSlides[groupId]--;
      showSlide(groupId, currentSlides[groupId], total);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    {% for like in likes %}
      {% with group_id="like"|add:forloop.counter|stringformat:"s" %}
        const total{{ forloop.counter }} = document.querySelectorAll(
          ".slide-group-{{ group_id }}"
        ).length;
        if (total{{ forloop.counter }} > 0) {
          showSlide("{{ group_id }}", 1, total{{ forloop.counter }});
        }
      {% endwith %}
    {% endfor %}
  });
</script>

{% endblock %}
